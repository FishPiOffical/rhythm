var Comment={editor:void 0,report:function(e){var t=$(e);t.attr("disabled","disabled").css("opacity","0.3"),$.ajax({url:Label.servePath+"/report",type:"POST",cache:!1,data:JSON.stringify({reportDataId:$("#reportDialog").data("id"),reportDataType:$("#reportDialog").data("type"),reportType:$("input[name=report]:checked").val(),reportMemo:$("#reportTextarea").val()}),complete:function(e){t.removeAttr("disabled").css("opacity","1"),0===e.responseJSON.code?(Util.alert(Label.reportSuccLabel),$("#reportTextarea").val(""),$("#reportDialog").dialog("close")):Util.alert(e.responseJSON.msg)}})},accept:function(e,t,i){confirm(e)&&$.ajax({url:Label.servePath+"/comment/accept",type:"POST",headers:{csrfToken:Label.csrfToken},cache:!1,data:JSON.stringify({commentId:t}),success:function(e){0===e.code?($(i).closest("li").addClass("cmt-perfect"),$(i).remove()):Util.alert(e.msg)}})},remove:function(e){if(!confirm("删除评论需要100积分，"+Label.confirmRemoveLabel))return!1;$.ajax({url:Label.servePath+"/comment/"+e+"/remove",type:"POST",cache:!1,success:function(t,i){0===t.code?$("#"+e).remove():Util.alert(t.msg)}})},exchangeCmtSort:function(e){e=0===e?1:0,window.location.href=window.location.pathname+"?m="+e},_bgFade:function(e){return 0!==e.length&&($(window).scrollTop(e[0].offsetTop-48),"comments"!==e.attr("id")&&(e.css({"background-color":"#9bbee0"}),setTimeout((function(){e.css({"background-color":"#FFF",transition:"all 3s cubic-bezier(0.56, -0.36, 0.58, 1)"})}),100),void setTimeout((function(){e.removeAttr("style")}),3100)))},edit:function(e){Comment._toggleReply(),$(".cmt-anonymous").hide(),$.ajax({url:Label.servePath+"/comment/"+e+"/content",type:"GET",cache:!1,success:function(e,t){0===e.code&&Comment.editor.setValue(e.commentContent)}}),$("#replyUseName").html('<a href="javascript:void(0)" onclick="Comment._bgFade($(\'#'+e+'\'))" class="ft-a-title"><svg><use xlink:href="#edit"></use></svg> '+Label.commonUpdateCommentPermissionLabel+"</a>").data("commentId",e)},goComment:function(e){if(0===$(e.substr(e.length-14,14)).length)return window.location=e,!1;$("#comments .list > ul > li").removeAttr("style"),Comment._bgFade($(e.substr(e.length-14,14)))},_setCmtVia:function(){$(".cmt-via").each((function(){var e=$(this).data("ua"),t=Util.getDeviceByUa(e);""!==t&&$(this).html("via "+t)}))},_toggleReply:function(e){return Label.isLoggedIn?0===$("#commentContent").length?(Util.alert(Label.notAllowCmtLabel),!1):"false"===$(this).data("hasPermission")?(Article.permissionTip(Label.noPermissionLabel),!1):$(".footer").attr("style")?($(".editor-panel .wrapper").slideUp((function(){$(".editor-panel").fadeOut(100),$(".footer").removeAttr("style")})),!1):($(".cmt-anonymous").show(),$(".footer").css("margin-bottom",$(".editor-panel > .wrapper").outerHeight()+"px"),$("#replyUseName").html('<a href="javascript:void(0)" onclick="Comment._bgFade($(\'.article-content\'))" class="ft-a-title"><svg><use xlink:href="#reply-to"></use></svg>'+$(".article-title").text().replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</a>").removeData(),"0px"!==$(".editor-panel").css("bottom")&&($(".editor-panel .wrapper").hide(),$(".editor-panel").css("bottom",0)),$(".editor-panel").show(),void $(".editor-panel .wrapper").slideDown((function(){Comment.editor.focus(),e&&e()}))):(Util.needLogin(),!1)},loadEmojis:function(){let e=Comment.getEmojis(),t="";for(let i=0;i<e.length;i++)t+=`<button onclick="Comment.editor.setValue(Comment.editor.getValue() + '![图片表情](${e[i]})')">\n    <div class="divX"><svg onclick='Comment.delEmoji("${e[i]}");event.cancelBubble =true;' style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg></div>\n    <img style='max-height: 50px' class="vditor-emojis__icon" src="${e[i]}">\n</button>`;$("#emojis").html(t)},confirmed:!1,delEmoji:function(e){if(!0===Comment.confirmed||confirm("确定要删除该表情包吗？")){Comment.confirmed=!0;let t=Comment.getEmojis();for(let i=0;i<t.length;i++)t[i]===e&&t.splice(i,1);t.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),Comment.loadEmojis(),setTimeout((function(){$("#emojiBtn").click()}),50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,t){if(ext=t.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var i=new FileReader;i.readAsArrayBuffer(t.files[0]),i.onload=function(e){var i=new Uint8Array(e.target.result.slice(0,11));isImage(i)?e.target.result.byteLength>5242880?Util.alert("图片过大 (最大限制 5M)"):t.submit():Util.alert("只允许上传图片!")}}else t.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){var i={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};Comment.addEmoji(i.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'Comment.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",(function(e){"13"==e.keyCode&&(Comment.addEmoji($("#fromURL").val()),Util.closeAlert())}))},addEmoji:function(){for(let e=0;e<arguments.length;e++){let t=arguments[e],i=Comment.getEmojis();i.reverse();for(let e=0;e<i.length;e++)i[e]===t&&i.splice(e,1);i.push(t),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:i}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),Comment.loadEmojis()},getEmojis:function(){let e;$.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(t){e=0===t.code&&""!==t.data?Util.parseArray(t.data):[]}});try{e.reverse()}catch(e){return[]}return e},_initHotKey:function(){if(!Label.userKeyboardShortcutsStatus||"1"===Label.userKeyboardShortcutsStatus)return!1;$(document).bind("keyup","x",(function(){return Util.prevKey="x",setTimeout((function(){Util.prevKey=void 0}),1e3),!1})).bind("keyup","v",(function(){return Util.prevKey="v",setTimeout((function(){Util.prevKey=void 0}),1e3),!1})).bind("keydown","r",(function(e){return Util.prevKey?"v"===Util.prevKey?$("#articleRewardContent .icon-points").click():1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-reply").parent().click():Comment._toggleReply(),!1})).bind("keyup","h",(function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-heart").parent().click(),!1})).bind("keyup","t",(function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-thumbs-up").parent().click(),!1})).bind("keyup","d",(function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-thumbs-down").parent().click(),!1})).bind("keyup","c",(function(){return 1===$("#comments .list > ul > li.focus .comment-info .icon-reply-to").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .comment-info .icon-reply-to").parent().click(),!1})).bind("keyup","m",(function(){return 1===$("#comments .list > ul > li.focus .comment-action > .ft-fade > .fn-pointer").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .comment-action > .ft-fade > .fn-pointer").click(),!1})).bind("keyup","a",(function(){return"x"===Util.prevKey&&1===$("#comments .list > ul > li.focus .icon-setting").parent().length&&(window.location=$("#comments .list > ul > li.focus .icon-setting").parent().attr("href")),!1})).bind("keyup","m",(function(){return"v"===Util.prevKey&&Article.toggleToc(),!1})).bind("keyup","h",(function(){return"v"===Util.prevKey&&$("#thankArticle").click(),!1})).bind("keyup","t",(function(){return"v"===Util.prevKey&&$(".article-header .icon-thumbs-up").parent().click(),!1})).bind("keyup","d",(function(){return"v"===Util.prevKey&&$(".article-header .icon-thumbs-down").parent().click(),!1})).bind("keyup","i",(function(){return"v"===Util.prevKey&&$(".article-header .icon-view").parent().click(),!1})).bind("keyup","c",(function(){return"v"===Util.prevKey&&$(".article-header .icon-star").parent().click(),!1})).bind("keyup","l",(function(){return"v"===Util.prevKey&&$(".article-header .icon-history").parent().click(),!1})).bind("keyup","e",(function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-edit").parent().length&&(window.location=$(".article-actions .icon-edit").parent().attr("href")),!1})).bind("keyup","s",(function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-chevron-up").length&&Article.stick(Label.articleOId),!1})).bind("keyup","a",(function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-setting").parent().length&&(window.location=$(".article-actions .icon-setting").parent().attr("href")),!1})).bind("keyup","p",(function(){return"v"===Util.prevKey&&1===$(".article-header a[rel=prev]").length&&(window.location=$(".article-header a[rel=prev]").attr("href")),!1})).bind("keyup","n",(function(){return"v"===Util.prevKey&&1===$(".article-header a[rel=next]").length&&(window.location=$(".article-header a[rel=next]").attr("href")),!1}))},init:function(){if($("#sendComment").click((function(){Comment._toggleReply()})),1===$(window.location.hash).length&&Comment._bgFade($(window.location.hash)),this._setCmtVia(),this._initHotKey(),$.pjax({selector:"#comments .pagination a",container:"#comments",show:"",cache:!1,storage:!0,titleSuffix:"",callback:function(){Util.parseMarkdown(),Util.parseHljs(),Util.listenUserCard()}}),NProgress.configure({showSpinner:!1}),$("#comments").bind("pjax.start",(function(){NProgress.start()})),$("#comments").bind("pjax.end",(function(){NProgress.done()})),!Label.isLoggedIn||!document.getElementById("commentContent"))return!1;Comment.editor=Util.newVditor({id:"commentContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"top"},height:200,placeholder:Label.commentEditorPlaceholderLabel,ctrlEnter:function(){Comment.add(Label.articleOId,Label.csrfToken,document.getElementById("articleCommentBtn"))},esc:function(){$(".editor-hide").click()}})},thank:function(e,t,i,n,o){if(!Label.isLoggedIn)return Util.needLogin(),!1;if(0===n&&!confirm(i))return!1;var r={commentId:e};$.ajax({url:Label.servePath+"/comment/thank",type:"POST",headers:{csrfToken:t},cache:!1,data:JSON.stringify(r),error:function(e,t,i){Util.alert(i)},success:function(e,t){if(0===e.code){$(o).removeAttr("onclick");var i=$('<svg class="ft-red"><use xlink:href="#heart"></use></svg>'),n=$(o).offset().top,r=$(o).offset().left;i.css({"z-index":9999,top:n,left:r,position:"absolute","font-size":16,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),$("body").append(i),i.animate({left:r-150,top:n-60,opacity:0},1e3,(function(){var e=parseInt($(o).text());$(o).html('<svg><use xlink:href="#heart"></use></svg> '+(e+1)).addClass("ft-red"),i.remove()}))}else Util.alert(e.msg)}})},showReply:function(e,t,i){var n=$(t).closest("li").find("."+i);if("comment-get-comment"===i){if(0!==n.find("li").length)return n.html(""),!1}else if(0===$(t).find(".icon-chevron-down").length)return $(t).find(".icon-chevron-up").removeClass("icon-chevron-up").addClass("icon-chevron-down").find("use").attr("xlink:href","#chevron-down"),n.html(""),!1;if("0.3"===$(t).css("opacity"))return!1;var o="/comment/replies";"comment-get-comment"===i&&(o="/comment/original"),$.ajax({url:Label.servePath+o,type:"POST",data:JSON.stringify({commentId:e,userCommentViewMode:Label.userCommentViewMode}),beforeSend:function(){$(t).css("opacity","0.3")},success:function(e,i){if(0!==e.code)return Util.alert(e.msg),!1;var o=e.commentReplies,r="";o instanceof Array||(o=[o]),0===o.length&&(r='<li class="ft-red">'+Label.removedLabel+"</li>");for(var a=0;a<o.length;a++){var s=o[a];r+='<li><div class="fn-flex">',r+='<a rel="nofollow" href="/member/'+s.commentAuthorName+'">',r+='<div class="avatar tooltipped tooltipped-se" aria-label="'+s.commentAuthorName+'" style="background-image:url('+s.commentAuthorThumbnailURL+')"></div>',r+="</a>",r+='<div class="fn-flex-1"><div class="comment-info ft-smaller">',r+='<a class="ft-gray" rel="nofollow" href="/member/'+s.commentAuthorName+'">',r+=s.commentAuthorNickName+" ("+s.commentAuthorName+")",r+="</a>",r+='<span class="ft-fade"> • '+s.timeAgo,s.rewardedCnt>0&&(r+='<span aria-label="'+(s.rewarded?Label.thankedLabel:Label.thankLabel+" "+s.rewardedCnt)+'" class="tooltipped tooltipped-n '+(s.rewarded?"ft-red":"ft-fade")+'"> <svg class="fn-text-top"><use xlink:href="#heart"></use></svg> '+s.rewardedCnt+"</span> "),r+=" "+Util.getDeviceByUa(s.commentUA)+"</span>",r+='<a class="tooltipped tooltipped-nw ft-a-title fn-right" aria-label="'+Label.referenceLabel+'" href="javascript:Comment.goComment(\''+Label.servePath+"/article/"+Label.articleOId+"?p="+s.paginationCurrentPageNum+"&m="+Label.userCommentViewMode+"#"+s.oId+'\')"><svg><use xlink:href="#quote"></use></svg></a></div><div class="vditor-reset comment">'+s.commentContent+"</div></div></div></li>"}n.html("<ul>"+r+"</ul>"),Util.parseHljs(),Util.parseMarkdown(),$(t).find(".icon-chevron-down").removeClass("icon-chevron-down").addClass("icon-chevron-up").find("use").attr("xlink:href","#chevron-up")},error:function(e){Util.alert(e.statusText)},complete:function(){$(t).css("opacity","1")}})},add:function(e,t,i){var n={articleId:e,commentAnonymous:$("#commentAnonymous").prop("checked"),commentVisible:$("#commentVisible").prop("checked"),commentContent:Comment.editor.getValue(),userCommentViewMode:Label.userCommentViewMode};$("#replyUseName").data("commentOriginalCommentId")&&(n.commentOriginalCommentId=$("#replyUseName").data("commentOriginalCommentId"));var o=Label.servePath+"/comment",r="POST",a=$("#replyUseName").data("commentId");a&&(o=Label.servePath+"/comment/"+a,r="PUT"),$.ajax({url:o,type:r,headers:{csrfToken:t},cache:!1,data:JSON.stringify(n),beforeSend:function(){$(i).attr("disabled","disabled").css("opacity","0.3")},success:function(e,t){$(i).removeAttr("disabled").css("opacity","1"),0===e.code?(a&&($("#"+a+" > .fn-flex > .fn-flex-1 > .vditor-reset").html(e.commentContent),$("#"+a+" .icon-history").parent().show()),n.commentOriginalCommentId&&Util.setUnreadNotificationCount(),Comment.editor.setValue(""),$(".editor-hide").click(),$("#replyUseName").text("").removeData(),1===Label.userCommentViewMode?Comment._bgFade($("#comments")):Comment._bgFade($("#bottomComment"))):$("#addCommentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#addCommentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(){$(i).removeAttr("disabled").css("opacity","1"),setTimeout(Util.listenUserCard,1e3)}})},reply:function(e,t){Comment._toggleReply((function(){$(window).height()-($("#"+t)[0].offsetTop-$(window).scrollTop()+$("#"+t).outerHeight())<$(".editor-panel .wrapper").outerHeight()&&$(window).scrollTop($("#"+t)[0].offsetTop-($(window).height()-$(".editor-panel .wrapper").outerHeight()-$("#"+t).outerHeight()))}));var i="",n=$("#"+t).find(">.fn-flex>div>a").clone();0===n.length?((n=$("#"+t).find(">.fn-flex .avatar").clone()).removeClass("avatar").addClass("avatar-small"),i='<a rel="nofollow" href="#'+t+'" class="ft-a-title" onclick="Comment._bgFade($(\'#'+t+'\'))"><svg><use xlink:href="#reply-to"></use></svg> '+n[0].outerHTML+" "+e+"</a>"):(n.addClass("ft-a-title").attr("href","#"+t).attr("onclick",'Comment._bgFade($("#'+t+'"))'),n.find("div").removeClass("avatar").addClass("avatar-small").after(" "+e).before('<svg><use xlink:href="#reply-to"></use></svg> '),i=n[0].outerHTML),$("#replyUseName").html(i).data("commentOriginalCommentId",t)}},Article={initAudio:function(){$(".content-audio").each((function(){var e=$(this);new APlayer({element:this,narrow:!1,autoplay:!1,mutex:!0,theme:"#4285f4",preload:"none",mode:"circulation",music:{title:e.data("title"),author:'<a href="'+Label.servePath+'/about" target="_blank">音乐分享</a>',url:e.data("url"),pic:Label.staticServePath+"/images/music.png"}})}));var e=$("#articleAudio");if(0===e.length)return!1;new APlayer({element:document.getElementById("articleAudio"),narrow:!1,autoplay:!1,mutex:!0,theme:"#4285f4",mode:"order",preload:"none",music:{title:"语音预览",author:'<a href="'+Label.servePath+'/about" target="_blank">小薇</a>',url:e.data("url"),pic:Label.staticServePath+"/images/blank.png"}})},permissionTip:function(e){Label.isLoggedIn?Util.alert(e):Util.needLogin()},voteUp:function(e,t,i){if(!Label.isLoggedIn)return Util.needLogin(),!1;var n=$(i),o=n.next();if(n.hasClass("disabled"))return!1;var r={dataId:e};n.addClass("disabled"),$.ajax({url:Label.servePath+"/vote/up/"+t,type:"POST",cache:!1,data:JSON.stringify(r),success:function(e,t){n.removeClass("disabled");var i=parseInt(n.text()),r=parseInt(o.text());0!==e.code?Util.alert(e.msg):0===e.type?n.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i-1)).removeClass("ft-red"):(n.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i+1)).addClass("ft-red"),o.hasClass("ft-red")&&o.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r-1)).removeClass("ft-red"))}})},voteDown:function(e,t,i){if(!Label.isLoggedIn)return Util.needLogin(),!1;var n=$(i),o=n.prev();if(n.hasClass("disabled"))return!1;var r={dataId:e};n.addClass("disabled"),$.ajax({url:Label.servePath+"/vote/down/"+t,type:"POST",cache:!1,data:JSON.stringify(r),success:function(e,t){n.removeClass("disabled");var i=parseInt(o.text()),r=parseInt(n.text());if(0===e.code)return 1===e.type?n.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r-1)).removeClass("ft-red"):(n.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r+1)).addClass("ft-red"),o.hasClass("ft-red")&&o.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i-1)).removeClass("ft-red")),!1;Util.alert(e.msg)}})},previewImgAfterLoading:function(){$(".img-preview img").css("transform","translate3d("+Math.max(0,$(window).width()-$(".img-preview img").width())/2+"px, "+Math.max(0,$(window).height()-$(".img-preview img").height())/2+"px, 0)"),setTimeout((function(){$(".img-preview").width($(window).width())}),300)},init:function(){this.initToc(),this.share(),Util.parseHljs(),Util.parseMarkdown();var e=null;$(".article").on("dblclick",".vditor-reset img",(function(){clearTimeout(e),$(this).hasClass("emoji")||1===$(this).closest(".editor-panel").length||1===$(this).closest(".ad").length||window.open($(this).attr("src"))})).on("click",".vditor-reset img",(function(t){if(clearTimeout(e),!$(this).hasClass("emoji")&&1!==$(this).closest(".editor-panel").length&&1!==$(this).closest(".ad").length){var i=$(this),n=this;e=setTimeout((function(){var e=n.offsetTop,t=n.offsetLeft;1===i.closest(".comments").length&&(e+=i.closest("li")[0].offsetTop,t=t+$(".comments")[0].offsetLeft+15),$("body").append('<div class="img-preview" onclick="$(this).remove()"><img style="transform: translate3d('+Math.max(0,t)+"px, "+Math.max(0,e-$(window).scrollTop())+'px, 0)" src="'+i.attr("src").split("?imageView2")[0]+'" onload="Article.previewImgAfterLoading()"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"})}),100)}}));var t=$("#articltVia").data("ua"),i=Util.getDeviceByUa(t);""!==i&&$("#articltVia").text("via "+i),$("#revision").dialog({width:Math.min($(window).width()-50,1e3,.8*$(window).width()),height:$(window).height()-50,modal:!0,hideFooter:!0}),$("#reportDialog").dialog({width:$(window).width()>500?500:$(window).width()-50,height:450,modal:!0,hideFooter:!0}),this.initAudio(),$(window).scroll((function(){var e=$(window).scrollTop();$(".share").css("top",e+60+"px"),e<$(".article-title").offset().top?($(".article-header").css("top","-60px"),$(".nav").show()):($(".article-header").css("top","0"),$(".nav").hide())})),$(window).resize((function(){if($("#articleToC > .module-panel").height($(window).height()-48),$(window).width()<1024)return 0===$("#articleToC").length||$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right","auto"),!1;if(1===$("#articleToC").length){var e=$("#articleToC").width(),t=($(window).width()-e-$(".article-info").width()-30)/3+e;$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right",t+"px")}}));var n=location.search.split("r=")[1];n&&sessionStorage.setItem("r",n.split("&")[0]),$((function(){$.ajax({url:Label.servePath+"/api/article/reward/senders/"+Label.articleOId,method:"GET",async:!1,headers:{csrfToken:Label.csrfToken},success:function(e){if(0===e.code&&""!==e.data){let t=e.data;for(let e=0;e<t.length;e++){let i=t[e];$("#articleThanksCnt").after('<a target="_blank" href="'+Label.servePath+"/member/"+i.userName+'">\n    <div class="article__participant">\n        <div class="avatar-small" aria-label="'+i.userName+'" style="background-image: url(\''+i.userAvatarURL48+"');\"></div>\n    </div>\n</a>")}Util.listenUserCard()}}})}))},revision:function(e,t){if(!Label.isLoggedIn)return Util.needLogin(),!1;t||(t="article"),$.ajax({url:Label.servePath+"/"+t+"/"+e+"/revisions",cache:!1,success:function(e,i){if(0===e.code){if(0===e.revisions.length||1===e.revisions.length)return $("#revision > .revisions").remove(),$("#revisions").html("<b>"+Label.noRevisionLabel+"</b>"),!1;$("#revisions").html("").prev().remove(),$("#revisions").data("revisions",e.revisions).before('<div class="revisions"><a href="javascript:void(0)" class="first"><svg><use xlink:href="#chevron-left"</svg></a><span>'+(e.revisions.length-1)+"~"+e.revisions.length+"/"+e.revisions.length+'</span><a href="javascript:void(0)" class="disabled last"><svg><use xlink:href="#chevron-right"</svg></a></div>'),e.revisions.length<=2&&$("#revision a").first().addClass("disabled");var n=JsDiff.createPatch("",e.revisions[e.revisions.length-2].revisionData.articleContent||e.revisions[e.revisions.length-2].revisionData.commentContent,e.revisions[e.revisions.length-1].revisionData.articleContent||e.revisions[e.revisions.length-1].revisionData.commentContent,e.revisions[e.revisions.length-2].revisionData.articleTitle||"",e.revisions[e.revisions.length-1].revisionData.articleTitle||"");return new Diff2HtmlUI({diff:n}).draw("#revisions",{matching:"lines",outputFormat:"side-by-side",synchronisedScroll:!0}),Article._revisionsControls(t),!1}Util.alert(e.msg)}}),$("#revision").dialog("open")},_revisionsControls:function(e){var t=$("#revisions").data("revisions");$("#revision a.first").click((function(){if(!$(this).hasClass("disabled")){var e=parseInt($("#revision .revisions").text().split("~")[0]);e<=2?$(this).addClass("disabled"):$(this).removeClass("disabled"),t.length>2&&$("#revision a.last").removeClass("disabled"),$("#revision .revisions > span").html(e-1+"~"+e+"/"+t.length);var i=JsDiff.createPatch("",t[e-2].revisionData.articleContent||t[e-2].revisionData.commentContent,t[e-1].revisionData.articleContent||t[e-1].revisionData.commentContent,t[e-2].revisionData.articleTitle||"",t[e-1].revisionData.articleTitle||"");new Diff2HtmlUI({diff:i}).draw("#revisions",{matching:"lines",outputFormat:"side-by-side",synchronisedScroll:!0})}})),$("#revision a.last").click((function(){if(!$(this).hasClass("disabled")){var e=parseInt($("#revision .revisions span").text().split("~")[0]);e>t.length-3?$(this).addClass("disabled"):$(this).removeClass("disabled"),t.length>2&&$("#revision a.first").removeClass("disabled"),$("#revision .revisions > span").html(e+1+"~"+(e+2)+"/"+t.length);var i=JsDiff.createPatch("",t[e].revisionData.articleContent||t[e].revisionData.commentContent,t[e+1].revisionData.articleContent||t[e+1].revisionData.commentContent,t[e].revisionData.articleTitle||"",t[e+1].revisionData.articleTitle||"");new Diff2HtmlUI({diff:i}).draw("#revisions",{matching:"lines",outputFormat:"side-by-side",synchronisedScroll:!0})}}))},share:function(){var e=$("#qrCode").data("shareurl");$("#qrCode").qrcode({width:90,height:90,text:e}),$("body").click((function(){$("#qrCode").slideUp()})),$(".share > span").click((function(){var t=$(this).data("type");if(!t)return!1;if("wechat"===t)return $("#qrCode").slideToggle(),!1;if("copy"===t)return!1;var i=encodeURIComponent(Label.articleTitle+" - "+Label.symphonyLabel),n=encodeURIComponent(e),o=$(".article-info .avatar-mid").css("background-image");pic=o.substring(5,o.length-2);var r={};r.tencent="http://share.v.t.qq.com/index.php?c=share&a=index&title="+i+"&url="+n+"&pic="+pic,r.weibo="http://v.t.sina.com.cn/share/share.php?title="+i+"&url="+n+"&pic="+pic,r.google="https://plus.google.com/share?url="+n,r.twitter="https://twitter.com/intent/tweet?status="+i+" "+n,window.open(r[t],"_blank","top=100,left=200,width=648,height=618")})),$("#qrCode").click((function(){$(this).hide()})),$("#shareClipboard").mouseover((function(){$(this).attr("aria-label",Label.copyLabel)})),Util.clipboard($("#shareClipboard"),$("#shareClipboard").next(),(function(){$("#shareClipboard").attr("aria-label",Label.copiedLabel)}))},reward:function(e){confirm(Label.rewardConfirmLabel)&&$.ajax({url:Label.servePath+"/article/reward?articleId="+e,type:"POST",cache:!1,success:function(e,t){if(0!==e.code)Util.alert(e.msg);else{$("#articleRewardContent .vditor-reset").html(e.articleRewardContent),Util.parseHljs(),Util.parseMarkdown();var i=$("#articleRewardContent > span"),n=parseInt(i.text());i.addClass("ft-red").removeClass("ft-blue").html(n+1+" "+Label.rewardLabel).removeAttr("onclick")}},error:function(e){Util.needLogin()}})},thankArticle:function(e,t){return Label.isLoggedIn?!(0===t&&!confirm(Label.thankArticleConfirmLabel))&&(Label.currentUserName===Label.articleAuthorName?(Util.alert(Label.thankSelfLabel),!1):void $.ajax({url:Label.servePath+"/article/thank?articleId="+e,type:"POST",cache:!1,success:function(e,t){if(0===e.code){var i=parseInt($("#thankArticle").text());$("#thankArticle").removeAttr("onclick").html('<svg><use xlink:href="#heart"></use></svg><span class="ft-13">'+(i+1)+"</span>").addClass("ft-red").removeClass("ft-blue");var n=$('<svg class="ft-red"><use xlink:href="#heart"></use></svg>'),o=$("#thankArticle").offset().top,r=$("#thankArticle").offset().left;return n.css({"z-index":9999,top:o-20,left:r,position:"absolute","font-size":16,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),$("body").append(n),n.animate({top:o-180,opacity:0},1500,(function(){n.remove()})),!1}Util.alert(e.msg)}})):(Util.needLogin(),!1)},stick:function(e){confirm(Label.stickConfirmLabel)&&$.ajax({url:Label.servePath+"/article/stick?articleId="+e,type:"POST",cache:!1,success:function(e,t){Util.alert(e.msg),window.location.href=Label.servePath+"/recent"}})},playThought:function(e){var t=String.fromCharCode(31),i=String.fromCharCode(30),n=String.fromCharCode(29),o=String.fromCharCode(10),r=String.fromCharCode(24),a=$("#thoughtProgress > span"),s=$("#thoughtProgress > svg"),l="#articleThought",c=function(e,i){var o=e.split(t);3===o.length&&o.splice(0,0,"");var a=o[0],s=o[2].split("-"),l=o[3].split("-");if(s[0]=parseInt(s[0]),s[1]=parseInt(s[1]),l[0]=parseInt(l[0]),l[1]=parseInt(l[1]),a===r){for(var c=[],d=s[1],m=0;l[1],d<i.length;d++,m++){if(s[1]===l[1]){i[d]=i[d].substring(0,s[0])+i[d].substr(l[0]);break}d===s[1]?i[d]=i[d].substr(0,s[0]):d===l[1]?(i[s[1]]+=i[d].substr(l[0]),i.splice(d,1)):c.push(d)}for(var u=0;u<c.length;u++)i.splice(c[u]-u,1)}else{var f=a.split(n)[0];""===a.split(n)[1]&&(i[s[1]]=i[s[1]].substring(0,s[0])+i[l[1]].substr(l[0]),i.splice(s[1]+1,l[1]-s[1])),void 0!==i[s[1]]?i[s[1]]=i[s[1]].substring(0,s[0])+f+i[s[1]].substr(s[0]):i[s[1]]=""}return i},d=e.split(i),m=Math.max(d[d.length-2].split(t)[1]/3e4,2);""===d[d.length-1]&&d.pop();for(var u=0,f=0;u<d.length;u++)setTimeout((function(){$(l).data("text")||$(l).data("text","");var e=c(d[f++],$(l).data("text").split(o)).join(o),t=e.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/	/g,"&nbsp;&nbsp;&nbsp;&nbsp;");$(l).data("text",e).html(t)}),parseInt(d[u].split(t)[1])/m);for(var h=0,p=parseInt(d[u-1].split(t)[1])/m,v=setInterval((function(){h>=p?(a.width("100%"),s.css("left","100%"),clearInterval(v)):(h+=20,s.css("left",100*h/p+"%"),a.width(100*h/p+"%"))}),20),g="",b="",w=0,C=0,y=0;C<d.length;C++){var k=c(d[y++],g.split(o)).join(o);b=k.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/	/g,"&nbsp;&nbsp;&nbsp;&nbsp;"),g=k,$(l).html(b),w=Math.max(w,$(l).height())}$("#thoughtProgressPreview").html('<div class="vditor-reset">'+b+"</div>"),$("#thoughtProgressPreview").dialog({modal:!0,hideFooter:!0}),s.click((function(){$("#thoughtProgressPreview").dialog("open")})),$(l).html(b).height(w).css("margin-bottom","15px").html("")},initToc:function(){if(0===$("#articleToC").length)return $(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right","auto"),!1;var e=$("#articleToC").width(),t=($(window).width()-e-$(".article-info").width()-30)/3+e;$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right",t+"px"),$("#articleToC > .module-panel").height($(window).height()-48);var i=$("#articleToC"),n=$(".article-toc"),o=$(".article-content [id^=toc]"),r=!1;i.offset().top;toc=[],i.find("li").click((function(){var e=$(this);setTimeout((function(){i.find("li").removeClass("current"),e.addClass("current")}),50)})),$(window).scroll((function(e){if(parseInt($("#articleToC").css("right"))<0)return!1;$("#articleToC > .module-panel").height($(window).height()-49),toc=[],o.each((function(e){toc.push({id:this.id,offsetTop:this.offsetTop})}));for(var t=$(window).scrollTop(),a=0,s=toc.length;a<s;a++)if(t<toc[a].offsetTop-53){i.find("li").removeClass("current");var l=a>0?a-1:0;i.find('a[data-id="'+toc[l].id+'"]').parent().addClass("current");break}t>=toc[toc.length-1].offsetTop-53&&(i.find("li").removeClass("current"),i.find("li:last").addClass("current"));var c=i.find("li.current")[0].offsetTop;r||(n.scrollTop()<c-n.height()+30&&n.scrollTop(c-n.height()+30),n.scrollTop()>c-30&&n.scrollTop(c)),setTimeout((function(){r=!1}),600)})),$(window).scroll(),n.scrollTop(i.find("li.current")[0].offsetTop).scroll((function(){r=!0}))},toggleToc:function(){var e=$("#articleToC");if(0===e.length)return!1;var t=$(".article-header .icon-unordered-list");t.hasClass("ft-red")?(e.animate({right:"-"+$("#articleToC").outerWidth()+"px"}),t.removeClass("ft-red"),$(".article-actions  .icon-unordered-list").removeClass("ft-red")):(e.animate({right:0}),t.addClass("ft-red"),$(".article-actions  .icon-unordered-list").addClass("ft-red"))},makeNotificationRead:function(e,t){var i={articleId:e,commentIds:t};$.ajax({url:Label.servePath+"/notifications/make-read",type:"POST",cache:!1,data:JSON.stringify(i)})}};Article.init(),$(document).ready((function(){Comment.init(),Comment.listenUploadEmojis(),Comment.loadEmojis(),(()=>{let e=(new Date).getTime(),t=0;const i=function(){0!==t&&(clearTimeout(t),t=0),$("#emojiList").css("top","auto"),$("#emojiList").css("bottom","60px"),e=(new Date).getTime(),t=setTimeout((()=>{(new Date).getTime()-e<=700&&$("#emojiList").removeClass("showList")}),null!==navigator.userAgent.match(/(phone|pad|pod|ios|Android|Mobile|BlackBerry|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian)/i)?0:600)};$("#emojiBtn").hover((function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime(),setTimeout((()=>0!==$("#emojiBtn:hover").length&&$("#emojiList").addClass("showList")),300)}),i),$("#emojiList").hover((function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime()}),i)})(),ArticleChannel.init(Label.articleChannel),Label.isLoggedIn&&(Article.makeNotificationRead(Label.articleOId,Label.notificationCmtIds),setTimeout((function(){Util.setUnreadNotificationCount()}),1e3))}));