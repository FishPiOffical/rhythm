var Chat={page:1,toUser:"",init:function(e){let a,t;if(void 0!==e){Chat.page=1;try{Chat.ws.close()}catch(e){}$("#chats").html(""),$("#chatTo"+Chat.toUser).css("background-color",""),Chat.toUser="",Chat.noMore=!1,t=e}else t=getQueryVariable("toUser");Chat.toUser=t,a=$.ajax({url:Label.servePath+"/chat/get-list?apiKey="+apiKey,type:"GET",async:!0,success:function(e){if(0===e.result){let a=e.data;0!==a.length&&a.forEach((e=>{"文件传输助手"===e.receiverUserName?$("#fileTransferMsg").html(e.preview):e.senderUserName!=Label.currentUserName?$("#chatTo"+e.senderUserName).length<=0&&Chat.addToMessageList(e.senderUserName,e.senderAvatar,e.preview,e.receiverOnlineFlag):$("#chatTo"+e.receiverUserName).length<=0&&Chat.addToMessageList(e.receiverUserName,e.receiverAvatar,e.preview,e.receiverOnlineFlag)}))}}}),$.when(a).done((function(){if(""!==t&&"FileTransfer"!==t)var e=$.ajax({url:Label.servePath+"/user/"+t,type:"GET",async:!0,success:function(e){-1===e.code&&(alert("指定的用户名不存在，请检查后重试！"),location.href=Label.servePath+"/chat"),$("#chatTo"+e.userName).length<=0&&Chat.addToMessageList(e.userName,e.userAvatarURL,"&nbsp;"),t=e.userName,Chat.toUser=t}});$.when(e).done((function(){if(""===t)$("#chatStatus").html('请在左侧列表选择最近聊天的成员，或直接发起聊天。<br><br><input class="form" id="chatWithInput" placeholder="输入用户名">&nbsp;<button onclick="Chat.startAChat()">发起聊天</button>'),$("#chatWithInput").keypress((function(e){13==e.which&&Chat.startAChat()})),$.ajax({url:Label.servePath+"/chat/has-unread?apiKey="+apiKey,type:"GET",async:!0,success:function(e){e.result;e.data.forEach((e=>{$("#chatTo"+e.senderUserName).css("background-color","#fff4eb")}))}});else{$("#chatTo"+t).css("background-color","#f1f1f1"),$("#chatStatus").html('和 <a href="'+Label.servePath+"/member/"+t+'">'+t+"</a> 聊天中"),$("#buttons").show(),$(".pagination__chat").show(),Chat.editor=Util.newVditor({id:"messageContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},height:150,placeholder:"说点什么吧，友善第一哦。",toolbar:["emoji","link","upload","edit-mode",{name:"more",toolbar:["insert-after","fullscreen","preview","info","help"]}],ctrlEnter:function(){Chat.send()}}),Chat.ws=new WebSocket(chatChannelURL+t),Chat.ws.onopen=function(){console.log("Connected to chat channel websocket.")},Chat.ws.onmessage=function(e){var a=JSON.parse(e.data);if("revoke"===a.type)$("#chat"+a.data).remove();else if(-1===a.code)$("#chatContentTip").addClass("error").html("<ul><li>"+a.msg+"</li></ul>");else{$("#chatContentTip").removeClass("error succ").html("");let e=a.oId,t=a.toId,s=(a.fromId,a.time),n=a.content,i=a.preview.substring(0,10),r=a.preview.length>10?"...":"",l=(a.user_session,a.senderUserName),o=a.senderAvatar,c=a.receiverUserName;a.receiverAvatar;if(l===Label.currentUserName){Chat.addSelfMsg(e,l,o,n,s,!1),$("#chatTo"+c).find("span").html(i+r);let a=$("#chatTo"+c).prop("outerHTML");$("#chatTo"+c).remove(),$("#chatMessageList").prepend(a),"1000000000086"===t&&$("#chatToFileTransfer").find("span").html(i+r)}else{Chat.addTargetMsg(e,l,o,n,s,!1),$("#chatTo"+l).find("span").html(i+r);let a=$("#chatTo"+l).prop("outerHTML");$("#chatTo"+l).remove(),$("#chatMessageList").prepend(a),$.ajax({url:Label.servePath+"/chat/mark-as-read?apiKey="+apiKey+"&fromUser="+Chat.toUser,type:"GET",async:!0})}}},Chat.ws.onclose=function(){console.log("Disconnected to chat channel websocket.")},Chat.ws.onerror=function(e){console.log("ERROR",e)},Chat.loadMore(),$(window).scroll((function(){var e=$(this).scrollTop(),a=$(document).height();e+$(this).height()+500>=a&&Chat.loadMore()})),$.ajax({url:Label.servePath+"/chat/mark-as-read?apiKey="+apiKey+"&fromUser="+Chat.toUser,type:"GET",async:!0});$.ajax({url:Label.servePath+"/chat/has-unread?apiKey="+apiKey,type:"GET",async:!0,success:function(e){e.result;e.data.forEach((e=>{$("#chatTo"+e.senderUserName).css("background-color","#fff4eb")}))}})}}))}))},startAChat(){let e=$("#chatWithInput").val();""!==e&&Chat.init(e)},noMore:!1,moreLock:!1,loadMore(){Chat.moreLock||(Chat.moreLock=!0,Chat.noMore||$.ajax({url:Label.servePath+"/chat/get-message?apiKey="+apiKey+"&toUser="+Chat.toUser+"&page="+Chat.page+"&pageSize=20",type:"GET",async:!0,success:function(e){try{e.data.length}catch(e){Chat.noMore=!0}Chat.noMore||(Chat.page++,e.data.forEach((e=>{let a=e.oId,t=(e.toId,e.fromId,e.time),s=e.content,n=(e.preview.substring(0,10),e.preview.length,e.user_session,e.senderUserName),i=e.senderAvatar;e.receiverUserName,e.receiverAvatar;n===Label.currentUserName?Chat.addSelfMsg(a,n,i,s,t,!0):Chat.addTargetMsg(a,n,i,s,t,!0)})))}}),Chat.moreLock=!1)},send(){let e=Chat.editor.getValue();e.length>1024?$("#chatContentTip").addClass("error").html("<ul><li>发送失败：超过 1024 字符，请修改后重试。</li></ul>"):(Chat.ws.send(e),Chat.editor.setValue(""))},addToMessageList(e,a,t,s){let n=t.length>10?"...":"",i=s?"[在线]":"[离线]";$("#chatMessageList").append('<div class="module-panel" id="chatTo'+e+'" style="padding: 10px 15px;cursor: pointer" onclick="Chat.init(\''+e+'\')"\n    <nav class="home-menu">\n        <div class="avatar"\n             style="display: inline-block; background-image:url('+a+')">\n        </div>\n        <div style="display: inline-block; vertical-align: -12px;">\n            '+e+'<br>\n            <span style="color: #868888">'+t.substring(0,10)+n+'</span>\n        </div>\n        <div style="float: right;display: inline-block; color: #868888">'+i+"</div>\n    </nav>\n</div>"),"none"===$("#messageListPanel").css("display")&&$("#messageListPanel").show()},addSelfMsg(e,a,t,s,n,i){let r="";try{let e=s.replace("<p>","").replace("</p>",""),a=Util.parseDom(e),t=!1,n="",i=0;for(let e=0;e<a.length;e++){let s=a.item(e);void 0!==s.src&&(t=!0,0!==i&&(n+=","),n+="'"+s.src+"'",i++)}t&&(r+='<a onclick="Chat.addEmoji('+n+')" class="item">一键收藏表情</a>')}catch(e){}r+="<a onclick=\"Chat.at('"+a+"', '"+e+'\')" class="item">引用</a>\n',!0===i?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+'\n        <span class="fn__space5"></span>            <details class="details action__item fn__flex-center">\n                <summary>\n                    ···\n                </summary>\n                <details-menu class="fn__layer">\n                    <a onclick="Chat.revoke(\''+e+'\')" class="item">撤回</a>\n'+r+"                </details-menu>\n            </details>        </div>    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+'\n        <span class="fn__space5"></span>            <details class="details action__item fn__flex-center">\n                <summary>\n                    ···\n                </summary>\n                <details-menu class="fn__layer">\n                    <a onclick="Chat.revoke(\''+e+'\')" class="item">撤回</a>\n'+r+"                </details-menu>\n            </details>        </div>    </div>\n</div>"),Util.listenUserCard()},addTargetMsg(e,a,t,s,n,i){let r=!0,l='<span class="fn__space5"></span><details class="details action__item fn__flex-center">\n<summary>\n···\n</summary>\n<details-menu class="fn__layer">\n';try{let e=s.replace("<p>","").replace("</p>",""),a=Util.parseDom(e),t=!1,n="",i=0;for(let e=0;e<a.length;e++){let s=a.item(e);void 0!==s.src&&(t=!0,0!==i&&(n+=","),n+="'"+s.src+"'",i++)}t&&(r=!0,l+='<a onclick="Chat.addEmoji('+n+')" class="item">一键收藏表情</a>')}catch(e){}l+="<a onclick=\"Chat.at('"+a+"', '"+e+'\')" class="item">引用</a>\n',l+="</details-menu>\n</details>";let o="";r&&(o=l),!0===i?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n"+o+"        </div>\n    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+n+"\n"+o+"        </div>\n    </div>\n</div>"),Util.listenUserCard()},revoke(e){$.ajax({url:Label.servePath+"/chat/revoke?apiKey="+apiKey+"&oId="+e,type:"GET",async:!0})},markAllAsRead(){$.ajax({url:Label.servePath+"/chat/mark-all-as-read?apiKey="+apiKey,type:"GET",async:!0,success:function(e){e.users.forEach((e=>{$("#chatTo"+e).css("background-color","")}))}})},at:function(e,a){Chat.editor.focus();let t="";$.ajax({url:Label.servePath+"/chat/raw/"+a+"?apiKey="+apiKey,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}}),Chat.editor.insertValue(`\n##### 引用 @${e} [↩](${Label.servePath}/chat#chat${a} "跳转至原消息")  \n> ${t}</span>\n`,!1);document.getElementById("messageContent").scrollIntoView({behavior:"smooth"})},loadEmojis:function(){let e=Chat.getEmojis(),a="";for(let t=0;t<e.length;t++)a+=`<button onclick="Chat.editor.setValue(Chat.editor.getValue() + '![图片表情](${e[t]})')">\n    <div class="divX"><svg onclick='Chat.delEmoji("${e[t]}");event.cancelBubble =true;' style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg></div>\n    <img style='max-height: 50px' class="vditor-emojis__icon" src="${e[t]}">\n</button>`;$("#emojis").html(a)},confirmed:!1,delEmoji:function(e){if(!0===Chat.confirmed||confirm("确定要删除该表情包吗？")){Chat.confirmed=!0;let a=Chat.getEmojis();for(let t=0;t<a.length;t++)a[t]===e&&a.splice(t,1);a.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:a}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),Chat.loadEmojis(),setTimeout((function(){$("#emojiBtn").click()}),50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){if(ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var t=new FileReader;t.readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?e.target.result.byteLength>5242880?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}}else a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,a){},done:function(e,a){var t={result:{key:a.result.data.succMap[Object.keys(a.result.data.succMap)[0]]}};Chat.addEmoji(t.result.key)},fail:function(e,a){Util.alert("Upload error: "+a.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column" style="border: none;width: 100%;box-shadow: none;background-color: #ffffff;padding: 0;">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'Chat.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",(function(e){"13"==e.keyCode&&(Chat.addEmoji($("#fromURL").val()),Util.closeAlert())}))},addEmoji:function(){for(let e=0;e<arguments.length;e++){let a=arguments[e],t=Chat.getEmojis();t.reverse();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.push(a),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),Chat.loadEmojis()},getEmojis:function(){let e;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(a){e=0===a.code&&""!==a.data?Util.parseArray(a.data):[]}}),e.reverse(),e}};function getQueryVariable(e){for(var a=window.location.search.substring(1).split("&"),t=0;t<a.length;t++){var s=a[t].split("=");if(s[0]==e)return s[1]}return""}$(document).ready((function(){Chat.init(),$("#sendChatBtn").on("click",(function(){Chat.send()})),$("#chats").on("click",".vditor-reset img",(function(e){if(!$(this).hasClass("emoji")&&1!==$(this).closest(".editor-panel").length&&1!==$(this).closest(".ad").length){var a=$(this);$("body").append('<div class="img-preview" onclick="$(this).remove()"><img src="'+a.attr("src").split("?imageView2")[0]+'" onload="Article.previewImgAfterLoading()"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"})}})),$(window).scroll((function(){$(this).scrollTop()>1?$("#goToTop").fadeIn():$("#goToTop").fadeOut()})),$("#goToTop a").click((function(){return $("html,body").animate({scrollTop:0},800),!1})),$("body").click((function(){$("details[open]").removeAttr("open")})),Chat.listenUploadEmojis(),Chat.loadEmojis(),(()=>{let e=(new Date).getTime(),a=0;const t=function(){0!==a&&(clearTimeout(a),a=0),e=(new Date).getTime(),a=setTimeout((()=>{(new Date).getTime()-e<=700&&$("#emojiList").removeClass("showList")}),null!==navigator.userAgent.match(/(phone|pad|pod|ios|Android|Mobile|BlackBerry|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian)/i)?0:600)};$("#emojiBtn").hover((function(){0!==a&&(clearTimeout(a),a=0),$("#emojiList").css("top","350px"),e=(new Date).getTime(),setTimeout((()=>0!==$("#emojiBtn:hover").length&&$("#emojiList").addClass("showList")),300)}),t),$("#emojiList").hover((function(){0!==a&&(clearTimeout(a),a=0),e=(new Date).getTime()}),t)})()}));