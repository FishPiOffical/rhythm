var AddArticle={editor:void 0,rewardEditor:void 0,recordThought:function(t,e,a){for(var l=JsDiff.diffChars(e,t),i=String.fromCharCode(31),r="",n=0,o=0,c=0,s=0,d=l.length,g=0;g<d;g++){var h=(new Date).getTime()-a.thoughtTime,$=l[g].value.split("\n");l[g].removed||l[g].added||(s=o=$.length-1+o,c=1===$.length?n+=$[$.length-1].length:n=$[$.length-1].length),l[g].removed?(c+=l[g].count,s+=$.length-1,r+=String.fromCharCode(24)+i+h+i+n+"-"+o+i+c+"-"+s+String.fromCharCode(30)):l[g].added&&(r+=l[g].value+i+h+i+n+"-"+o+i+c+"-"+s+String.fromCharCode(30),c=n=0===$[$.length-1].length?0:$[$.length-1].length+n,s=o=$.length-1+o)}a.thoughtContent+=r},remove:function(t,e){confirm(Label.confirmRemoveLabel)&&$.ajax({url:Label.servePath+"/article/"+Label.articleOId+"/remove",type:"POST",headers:{csrfToken:t},cache:!1,beforeSend:function(){$(e).attr("disabled","disabled").css("opacity","0.3")},error:function(t,e,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(t,a){$(e).removeAttr("disabled").css("opacity","1"),0===t.code?window.location.href=Label.servePath+"/member/"+Label.userName:$("#addArticleTip").addClass("error").html("<ul><li>"+t.msg+"</li></ul>")},complete:function(){$(e).removeAttr("disabled").css("opacity","1")}})},confirmAdd:function(t,e){$(".tags-input").length>0&&0===$(".tags-input .tag .text").length?$("#addArticleTip").addClass("error").html("<ul><li>为了让你的文章更好地被归类和展示，请至少填写一个标签哦 :)</li></ul>"):6!==Label.articleType?0===$(".tags-input").length||-1!=$(".tags-input .tag .text").text().indexOf("新人报道")||-1!=$(".tags-input .tag .text").text().indexOf("新人报到")?AddArticle.add(t,e):Swal.fire({html:"根据 <a href='https://fishpi.cn/article/1684378758315' target='_blank'>摸鱼派发帖规范细则</a>，请对您的帖子进行自觉分类，自行选择是否获得<a target='_blank' href='https://fishpi.cn/article/1683775497629'>好帖积分和活跃度奖励</a> (300积分和45%活跃度，每日仅第一次有效)<br><br><b>有积分奖励的帖子：</b>原创的技术文章 / 原创且用心的美食、旅游、生活内容 / 发自内心的分享 / 有营养的问答 / 原创且用心的长短篇小说、故事、纪实创作<br><br><b>没有积分奖励的帖子：</b>发牢骚、感慨 / 非原创的内容 / 无意义内容帖、单纯的水帖 / 新人报道帖 / 广告帖 / 不用心、无价值的长短篇小说、故事、纪实创作<br><br><b>请注意：</b><b>帖子发布后24小时内无法删除！</b>如果不知道该选哪个，请选“我就随便写写”，选择领取奖励后，我们将对帖子进行检查，如不符合规则，您的积分奖励将会被扣除。",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#707070",confirmButtonText:"这是好帖，给我奖励！",cancelButtonText:"我就随便写写，不需要奖励"}).then(a=>{a.isConfirmed?AddArticle.add(t,e,!0):a.dismiss===Swal.DismissReason.cancel&&AddArticle.add(t,e)}):AddArticle.add(t,e,!0)},add:function(t,e,a){var l=$(".tags-input").length>0;if(l&&0===$(".tags-input .tag .text").length)$("#addArticleTip").addClass("error").html("<ul><li>为了让你的文章更好地被归类和展示，请至少填写一个标签哦 :)</li></ul>");else if(Validate.goValidate({target:$("#addArticleTip"),data:[{type:"string",max:256,msg:Label.articleTitleErrorLabel,target:$("#articleTitle")}]})){var i=0,r=$("input[type='radio'][name='articleType']:checked");if(r.length>0&&(i=parseInt(r.val())),5!==i&&$("#articleRewardPoint").length>0&&$("#articleRewardPoint").data("orval")&&!/^\+?[1-9][0-9]*$/.test($("#articleRewardPoint").val()))return $("#addArticleTip").addClass("error").html("<ul><li>"+Label.articleRewardPointErrorLabel+"</li></ul>"),!1;var n="";l&&$(".tags-input .tag .text").each(function(){n+=$(this).text()+","});var o=r.length>0?i:Label.articleType,c={articleTitle:$("#articleTitle").val().replace(/(^\s*)|(\s*$)/g,""),articleContent:this.editor.getValue(),articleTags:n,articleType:o};if($("#articleCommentable").length>0?c.articleCommentable=$("#articleCommentable").prop("checked"):c.articleCommentable=!0,$("#articleNotifyFollowers").length>0&&(c.articleNotifyFollowers=$("#articleNotifyFollowers").prop("checked")),$("#articleShowInList").length>0&&(c.articleShowInList=Boolean($("#articleShowInList").prop("checked"))?1:0),$("#longArticleColumnId").length>0){var s=$("#longArticleColumnId").val(),d="";if("__NEW__"===s&&""===(d=$("#longArticleColumnTitle").val().replace(/(^\s*)|(\s*$)/g,"")))return $("#addArticleTip").addClass("error").html("<ul><li>请输入新专栏名称</li></ul>"),!1;c.columnId=s,c.columnTitle=d;var g="";if(""!==s&&$("#longArticleChapterNo").length>0&&(g=$("#longArticleChapterNo").val().replace(/(^\s*)|(\s*$)/g,"")),""!==g&&!/^[1-9][0-9]*$/.test(g))return $("#addArticleTip").addClass("error").html("<ul><li>章节号必须是正整数</li></ul>"),!1;c.chapterNo=g}$("#articleStatement").length>0&&(c.articleStatement=$("#articleStatement").val()),void 0!==a&&!0===a&&(c.isGoodArticle="yes"),5!==o?($("#articleRewardContent").length>0&&(c.articleRewardContent=this.rewardEditor.getValue()),$("#articleRewardPoint").length>0&&(c.articleRewardPoint=$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")),$("#articleAnonymous").length>0&&(c.articleAnonymous=$("#articleAnonymous").prop("checked"))):c.articleQnAOfferPoint=$("#articleAskPoint").val().replace(/(^\s*)|(\s*$)/g,"");var h=Label.servePath+"/article",u="POST";3===parseInt(c.articleType)&&(c.articleContent=JSON.parse(window.localStorage.postData).thoughtContent),Label.articleOId&&(h=h+"/"+Label.articleOId,u="PUT"),$.ajax({url:h,type:u,headers:{csrfToken:t},cache:!1,data:JSON.stringify(c),beforeSend:function(){$(e).attr("disabled","disabled").css("opacity","0.3")},error:function(t,e,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(t,a){$(e).removeAttr("disabled").css("opacity","1"),0===t.code?(window.location.href=Label.servePath+"/article/"+t.articleId,localStorage.removeItem("postData"),AddArticle.editor.clearCache(),AddArticle.rewardEditor&&AddArticle.rewardEditor.clearCache()):$("#addArticleTip").addClass("error").html("<ul><li>"+t.msg+"</li></ul>")},complete:function(){$(e).removeAttr("disabled").css("opacity","1")}})}},init:function(){$.ua.set(navigator.userAgent),location.search.indexOf("?id=")>-1&&localStorage.removeItem("postData");var t=void 0;localStorage.postData?t=JSON.parse(localStorage.postData):(t={title:"",content:"",tags:"",thoughtContent:"",rewardContent:"",rewardPoint:"",thoughtTime:(new Date).getTime()},localStorage.postData=JSON.stringify(t)),""!==t.content&&$("#articleContent").val(t.content);var e=t.content;if(AddArticle.editor=Util.newVditor({outline:{enable:!0,position:"left"},typewriterMode:!0,id:"articleContent",cache:!Label.articleOId,preview:{mode:"both"},resize:{enable:!0,position:"bottom"},after:function(){""!==$("#articleContent").next().val()&&AddArticle.editor.setValue($("#articleContent").next().val())},height:500,placeholder:$("#articleContent").data("placeholder"),input:function(){if(3===Label.articleType){var t=JSON.parse(localStorage.postData);e=localStorage.getItem("vditorarticleContent")||"",AddArticle.recordThought(AddArticle.editor.getValue(),e,t),localStorage.postData=JSON.stringify(t)}}}),-1!==location.href.indexOf("at=")){if(""==t.content){var a=AddArticle.editor.getValue();AddArticle.editor.setValue("\n\n\n"+a)}if(""==t.title){var l=Util.getParameterByName("at");$("#articleTitle").val("Hi, "+l)}if(""!==t.tags){var i=Label.discussionLabel,r=Util.getParameterByName("tags");""!==r&&(i+=","+r),$("#articleTags").val(i)}}if(""==t.title){var n=Util.getParameterByName("title");n&&n.length>0&&$("#articleTitle").val(n)}""!==t.title&&$("#articleTitle").val(t.title),$("#articleTitle").keyup(function(){var t=JSON.parse(localStorage.postData);t.title=$(this).val(),localStorage.postData=JSON.stringify(t)}),""!==t.tags&&$("#articleTags").val(t.tags),this._initTag(),this._initLongArticleColumn(),$("#articleTitle").val().length<=0&&$("#articleTitle").focus(),$("#articleTitle").blur(function(){if(""===$.trim($(this).val()))return!1;1!==Label.articleType&&$.ajax({url:Label.servePath+"/article/check-title",type:"POST",data:JSON.stringify({articleTitle:$.trim($(this).val()),articleId:Label.articleOId}),success:function(t,e){0!==t.code?1===$("#articleTitleTip").length?$("#articleTitleTip").html(t.msg):$("#articleTitle").after('<div class="module" id="articleTitleTip">'+t.msg+"</div>"):$("#articleTitleTip").remove()}})}),$("#articleTags, #articleRewardPoint, #articleAskPoint").keypress(function(t){if(t.ctrlKey&&10===t.charCode)return AddArticle.add(),!1}),0===$("#articleAskPoint").length&&$("#articleRewardContent").length>0&&(0<$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")&&$("#showReward").click(),AddArticle.rewardEditor=Util.newVditor({id:"articleRewardContent",cache:!Label.articleOId,preview:{mode:"editor"},resize:{enable:!1},height:200,placeholder:$("#articleRewardContent").data("placeholder"),after:function(){""!==$("#articleRewardContent").next().val()&&($("#showReward").click(),AddArticle.rewardEditor.setValue($("#articleRewardContent").next().val()))}})),0===$("#articleAskPoint").length&&$("#articleRewardPoint").length>0?(""!==t.rewardContent&&($("#showReward").click(),AddArticle.rewardEditor.setValue(t.rewardContent)),""!==t.rewardPoint&&($("#showReward").click(),$("#articleRewardPoint").val(t.rewardPoint)),$("#articleRewardPoint").keyup(function(){var t=JSON.parse(localStorage.postData);t.rewardPoint=$(this).val(),localStorage.postData=JSON.stringify(t)})):$("#articleAskPoint").length>0&&($("#articleAskPoint").keyup(function(){var t=JSON.parse(localStorage.postData);t.QnAOfferPoint=$(this).val(),localStorage.postData=JSON.stringify(t)}),""!==t.QnAOfferPoint&&""===$("#articleAskPoint").val()&&$("#articleAskPoint").val(t.QnAOfferPoint))},_initLongArticleColumn:function(){0!==$("#longArticleColumnId").length&&($("#longArticleColumnId").change(function(){AddArticle.toggleLongColumnCreate()}),AddArticle.toggleLongColumnCreate())},toggleLongColumnCreate:function(){if(0!==$("#longArticleColumnId").length){var t=$("#longArticleColumnId").val(),e="__NEW__"===t,a=""!==t;$("#longArticleColumnTitleWrap").length>0&&(e?($("#longArticleColumnTitleWrap").show(),$("#longArticleColumnTitle").focus()):$("#longArticleColumnTitleWrap").hide()),$("#longArticleChapterWrap").length>0&&$("#longArticleChapterNo").length>0&&(a?($("#longArticleChapterWrap").show(),$("#longArticleChapterNo").prop("disabled",!1)):($("#longArticleChapterWrap").hide(),$("#longArticleChapterNo").prop("disabled",!0).val("")))}},_initTag:function(){if(0!==$("#articleTags").length&&0!==$(".tags-input").length){$.ua.set(navigator.userAgent);var t=function(t){if(""===t.replace(/\s/g,""))return!1;var e=!1;if(t=t.replace(/\s/g,"").replace(/,/g,""),$("#articleTags").val(""),$(".tags-input .text").each(function(){var a=$(this);t===a.text()&&(a.parent().addClass("haved"),setTimeout(function(){a.parent().removeClass("haved")},900),e=!0)}),e)return!1;if($(".tags-input .tag").length>=4)return $("#articleTags").val("").data("val",""),!1;if($(".post .tags-selected").append('<span class="tag"><span class="text">'+t+'</span><span class="close">x</span></span>'),-1===location.search.indexOf("?id=")){var a="";$(".tags-input .tag .text").each(function(){a+=$(this).text()+","});var l=JSON.parse(localStorage.postData);l.tags=a,localStorage.postData=JSON.stringify(l)}$(".tags-input .tag").length>=4&&$("#articleTags").val("").data("val","")};$(".domains-tags .btn").click(function(){$(".domains-tags .btn.current").removeClass("current green"),$(this).addClass("current").addClass("green"),$(".domains-tags .domain-tags").hide(),$("#tags"+$(this).data("id")).show()});for(var e=$("#articleTags").val().split(","),a=0,l=e.length;a<l;a++)t(e[a]);$(".domain-tags .tag").click(function(){t($(this).text())}),$(".tags-input").on("click",".tag > span.close",function(){if($(this).parent().remove(),-1===location.search.indexOf("?id=")){var t="";$(".tags-input .tag .text").each(function(){t+=$(this).text()+","});var e=JSON.parse(localStorage.postData);e.tags=t,localStorage.postData=JSON.stringify(e)}}),$("#articleTags").click(function(){$(".post .domains-tags").show(),"mobile"!==$.ua.device.type&&$(".post .domains-tags").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTagsSelectedPanel").hide()}).blur(function(){if("block"===$("#articleTagsSelectedPanel").css("display"))return!1;t($(this).val())}),$("body").click(function(t){1===$(t.target).closest(".tags-input").length||1===$(t.target).closest(".domains-tags").length||$(".post .domains-tags").hide()}),$("#articleTags").completed({height:170,onlySelect:!0,data:[],afterSelected:function(e){t(e.text())},afterKeyup:function(e){if($(".post .domains-tags").hide(),","===e.key||"，"===e.key||"、"===e.key||"；"===e.key||";"===e.key){var a=$("#articleTags").val();return t(a.substr(0,a.length-1)),!1}return 13===e.keyCode?(t($("#articleTags").val()),!1):37!==e.keyCode&&39!==e.keyCode&&38!==e.keyCode&&40!==e.keyCode&&(27===e.keyCode?($("#articleTagsSelectedPanel").hide(),!1):8===e.keyCode&&8===e.data.settings.chinese&&""===e.data.settings.keydownVal.replace(/\s/g,"")?($(".tags-input .tag .close:last").click(),!1):""!==$("#articleTags").val().replace(/\s/g,"")&&void $.ajax({url:Label.servePath+"/tags/query?title="+$("#articleTags").val(),error:function(t,e,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(t,e){0===t.code?("mobile"!==$.ua.device.type&&$("#articleTagsSelectedPanel").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTags").completed("updateData",t.tags)):console.log(t)}}))}})}}};AddArticle.init();