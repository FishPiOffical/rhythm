!function(){if("undefined"!=typeof window){var e={page:1,pageSize:20,medals:[],ownersPage:1,ownersPageSize:20,ownersTotal:0,currentOwnersMedalId:null,keyword:"",hasMore:!0,init:function(){document.getElementById("medalAdminRoot")&&(this.cacheDom(),this.bindEvents(),this.loadMedals())},cacheDom:function(){this.dom={},this.dom.tableBody=document.getElementById("medalTableBody"),this.dom.mobileList=document.getElementById("medalMobileList"),this.dom.pageLabel=document.getElementById("medalPage"),this.dom.btnPrev=document.getElementById("medalPrevPage"),this.dom.btnNext=document.getElementById("medalNextPage"),this.dom.btnCreate=document.getElementById("btnCreateMedal"),this.dom.searchInput=document.getElementById("medalSearchInput"),this.dom.btnSearch=document.getElementById("btnSearchMedal"),this.dom.btnResetSearch=document.getElementById("btnResetSearchMedal"),this.dom.modalEdit=document.getElementById("medalEditModal"),this.dom.modalEditTitle=document.getElementById("medalEditModalTitle"),this.dom.formEdit=document.getElementById("medalEditForm"),this.dom.inputMedalId=document.getElementById("medalId"),this.dom.inputMedalName=document.getElementById("medalName"),this.dom.inputMedalType=document.getElementById("medalType"),this.dom.inputMedalDesc=document.getElementById("medalDescription"),this.dom.inputMedalAttr=document.getElementById("medalAttr"),this.dom.btnSaveMedal=document.getElementById("btnSaveMedal"),this.dom.modalOwners=document.getElementById("medalOwnersModal"),this.dom.ownersMedalIdLabel=document.getElementById("ownersMedalIdLabel"),this.dom.ownersTableBody=document.getElementById("medalOwnersTableBody"),this.dom.ownersPageLabel=document.getElementById("ownersPage"),this.dom.ownersTotalLabel=document.getElementById("ownersTotal"),this.dom.ownersPrev=document.getElementById("ownersPrevPage"),this.dom.ownersNext=document.getElementById("ownersNextPage"),this.dom.grantUserId=document.getElementById("grantUserId"),this.dom.grantExpireTime=document.getElementById("grantExpireTime"),this.dom.grantData=document.getElementById("grantData"),this.dom.btnGrant=document.getElementById("btnGrantMedalToUser")},bindEvents:function(){var e=this;this.dom.btnCreate&&this.dom.btnCreate.addEventListener("click",(function(){e.openCreateModal()})),this.dom.btnSearch&&this.dom.btnSearch.addEventListener("click",(function(){var t=(e.dom.searchInput&&e.dom.searchInput.value||"").trim();e.keyword=t,e.page=1,e.hasMore=!0,e.loadMedals()})),this.dom.searchInput&&this.dom.btnSearch&&this.dom.searchInput.addEventListener("keydown",(function(t){var a=t||window.event;"Enter"!==a.key&&13!==a.keyCode||(a.preventDefault(),e.dom.btnSearch.click())})),this.dom.btnResetSearch&&this.dom.btnResetSearch.addEventListener("click",(function(){e.keyword="",e.dom.searchInput&&(e.dom.searchInput.value=""),e.page=1,e.hasMore=!0,e.loadMedals()})),this.dom.btnPrev&&this.dom.btnPrev.addEventListener("click",(function(){e.keyword&&e.keyword.trim()||e.page>1&&(e.page-=1,e.hasMore=!0,e.loadMedals())})),this.dom.btnNext&&this.dom.btnNext.addEventListener("click",(function(){e.keyword&&e.keyword.trim()||e.hasMore&&(e.page+=1,e.loadMedals())})),this.dom.btnSaveMedal&&this.dom.btnSaveMedal.addEventListener("click",(function(){e.saveMedal()})),this.dom.modalEdit&&this.dom.modalEdit.addEventListener("click",(function(t){null==t.target.getAttribute("data-medal-modal-close")&&t.target!==e.dom.modalEdit.querySelector(".medal-modal__backdrop")||e.closeModal(e.dom.modalEdit)})),this.dom.modalOwners&&this.dom.modalOwners.addEventListener("click",(function(t){null==t.target.getAttribute("data-medal-modal-close")&&t.target!==e.dom.modalOwners.querySelector(".medal-modal__backdrop")||e.closeModal(e.dom.modalOwners)})),this.dom.ownersPrev&&this.dom.ownersPrev.addEventListener("click",(function(){e.ownersPage>1&&(e.ownersPage-=1,e.loadMedalOwners(e.currentOwnersMedalId))})),this.dom.ownersNext&&this.dom.ownersNext.addEventListener("click",(function(){var t=Math.ceil(e.ownersTotal/e.ownersPageSize);e.ownersPage<t&&(e.ownersPage+=1,e.loadMedalOwners(e.currentOwnersMedalId))})),this.dom.btnGrant&&this.dom.btnGrant.addEventListener("click",(function(){e.grantMedalToUser()}))},apiPayloadBase:function(){return{apiKey:void 0!==window.apiKey?window.apiKey:null}},loadMedals:function(){var e,a=this,d=this.apiPayloadBase();this.keyword&&this.keyword.trim().length>0?(e="/api/medal/admin/search",d.keyword=this.keyword.trim()):(e="/api/medal/admin/list",d.page=this.page,d.pageSize=this.pageSize),t(e,d).then((function(e){if(e&&0===e.code){var t=e.data||[];a.medals=t,a.keyword&&a.keyword.trim()||(!t||t.length<a.pageSize?a.hasMore=!1:a.hasMore=!0),a.renderMedals()}else alert("加载勋章失败："+(e?e.msg:"未知错误"))})).catch((function(e){alert("加载勋章失败："+e)}))},renderMedals:function(){var e=this;if(this.dom.tableBody)if(this.medals&&0!==this.medals.length){var t=this.medals.map((function(e){var t=(e.medal_description||"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a=(e.medal_attr||"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),d=e.medal_id||"",n=(window.Label&&Label.servePath?Label.servePath:"")+"/gen?id="+encodeURIComponent(d);return'<tr data-medal-id="'+d+'"><td>'+d+"</td><td>"+(e.medal_name||"")+"</td><td>"+(e.medal_type||"")+"</td><td>"+t+'</td><td><pre style="white-space:pre-wrap;max-width:200px;">'+a+'</pre></td><td><img src="'+n+'" alt="预览" style="max-width:60px;max-height:60px;border-radius:4px;"/></td><td class="medal-table__actions"><button type="button" class="btn btn-primary" data-action="edit">编辑</button><button type="button" class="btn btn-secondary" data-action="owners">拥有者</button><button type="button" class="btn btn-secondary" data-action="delete">删除</button></td></tr>'})).join("");this.dom.tableBody.innerHTML=t,Array.prototype.forEach.call(this.dom.tableBody.querySelectorAll("button[data-action]"),(function(t){t.addEventListener("click",(function(){var a=t.closest("tr"),d=a&&a.getAttribute("data-medal-id"),n=t.getAttribute("data-action");d&&("edit"===n?e.openEditModal(d):"delete"===n?e.confirmDeleteMedal(d):"owners"===n&&e.openOwnersModal(d))}))}))}else this.dom.tableBody.innerHTML='<tr><td colspan="6" class="medal-table__empty">暂无勋章</td></tr>';if(this.dom.mobileList)if(this.medals&&0!==this.medals.length){var a=this.medals.map((function(e){var t=e.medal_description||"",a=e.medal_id||"";return'<div class="medal-admin__list-item" data-medal-id="'+a+'"><div class="medal-admin__list-header"><img class="medal-admin__thumb" src="'+((window.Label&&Label.servePath?Label.servePath:"")+"/gen?id="+encodeURIComponent(a))+'" alt="预览"/><div class="medal-admin__list-title">'+(e.medal_name||"")+"（ID: "+a+'）</div></div><div class="medal-admin__list-meta">类型：'+(e.medal_type||"")+'</div><div class="medal-admin__list-desc">'+t+'</div><div class="medal-admin__list-actions"><button type="button" class="btn btn-primary" data-action="edit">编辑</button><button type="button" class="btn btn-secondary" data-action="owners">拥有者</button><button type="button" class="btn btn-secondary" data-action="delete">删除</button></div></div>'})).join("");this.dom.mobileList.innerHTML=a,Array.prototype.forEach.call(this.dom.mobileList.querySelectorAll("button[data-action]"),(function(t){t.addEventListener("click",(function(){var a=t.closest(".medal-admin__list-item"),d=a&&a.getAttribute("data-medal-id"),n=t.getAttribute("data-action");d&&("edit"===n?e.openEditModal(d):"delete"===n?e.confirmDeleteMedal(d):"owners"===n&&e.openOwnersModal(d))}))}))}else this.dom.mobileList.innerHTML='<div class="medal-admin__list-empty">暂无勋章</div>';this.dom.pageLabel&&(this.dom.pageLabel.textContent=String(this.page))},openCreateModal:function(){this.dom.modalEdit&&(this.dom.modalEditTitle.textContent="新建勋章",this.dom.inputMedalId.value="",this.dom.inputMedalName.value="",this.dom.inputMedalType.value="",this.dom.inputMedalDesc.value="",this.dom.inputMedalAttr.value="",this.openModal(this.dom.modalEdit))},openEditModal:function(e){for(var t=null,a=0;a<this.medals.length;a++)if(String(this.medals[a].medal_id)===String(e)){t=this.medals[a];break}t&&this.dom.modalEdit&&(this.dom.modalEditTitle.textContent="编辑勋章 "+t.medal_id,this.dom.inputMedalId.value=t.medal_id||"",this.dom.inputMedalName.value=t.medal_name||"",this.dom.inputMedalType.value=t.medal_type||"",this.dom.inputMedalDesc.value=t.medal_description||"",this.dom.inputMedalAttr.value=t.medal_attr||"",this.openModal(this.dom.modalEdit))},openModal:function(e){e&&e.classList.add("is-open")},closeModal:function(e){e&&e.classList.remove("is-open")},saveMedal:function(){var e=this;if(this.dom.formEdit){var a=(this.dom.inputMedalId.value||"").trim(),d=(this.dom.inputMedalName.value||"").trim(),n=(this.dom.inputMedalType.value||"").trim(),i=(this.dom.inputMedalDesc.value||"").trim(),o=(this.dom.inputMedalAttr.value||"").trim();if(d){var l=this.apiPayloadBase();a&&(l.medalId=a),l.name=d,l.type=n,l.description=i,l.attr=o,t(a?"/api/medal/admin/edit":"/api/medal/admin/create",l).then((function(t){t&&0===t.code?(alert("保存成功"),e.closeModal(e.dom.modalEdit),e.loadMedals()):alert("保存失败："+(t?t.msg:"未知错误"))})).catch((function(e){alert("保存失败："+e)}))}else alert("勋章名称不能为空")}},confirmDeleteMedal:function(e){var a=this;if(window.confirm("确认删除勋章 "+e+" 吗？此操作不可撤销。")){var d=this.apiPayloadBase();d.medalId=e,t("/api/medal/admin/delete",d).then((function(e){e&&0===e.code?(alert("删除成功"),a.loadMedals()):alert("删除失败："+(e?e.msg:"未知错误"))})).catch((function(e){alert("删除失败："+e)}))}},openOwnersModal:function(e){this.dom.modalOwners&&(this.currentOwnersMedalId=e,this.ownersPage=1,this.dom.ownersMedalIdLabel.textContent=String(e),this.loadMedalOwners(e),this.openModal(this.dom.modalOwners))},loadMedalOwners:function(e){var a=this,d=this.apiPayloadBase();d.medalId=e,d.page=this.ownersPage,d.pageSize=this.ownersPageSize,t("/api/medal/admin/owners",d).then((function(e){if(e&&0===e.code){var t=e.data||{},d=t.items||[];a.ownersTotal=t.total||0,a.renderMedalOwners(d)}else alert("加载拥有者失败："+(e?e.msg:"未知错误"))})).catch((function(e){alert("加载拥有者失败："+e)}))},renderMedalOwners:function(e){var t=this;if(this.dom.ownersTableBody){if(e&&0!==e.length){var a=e.map((function(e){var t=e.user_id||"",a=e.userName||"",d=e.medal_id||"",n=e.expire_time,i=e.data||"";return'<tr data-user-id="'+t+'" data-medal-id="'+d+'"><td>'+t+"</td><td>"+a+"</td><td>"+function(e){if(!e||e<=0)return"永久";try{var t=new Date(e);return isNaN(t.getTime())?String(e):t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)}catch(t){return String(e)}}(n)+"</td><td>"+(!1===e.display?"否":"是")+'</td><td><pre style="white-space:pre-wrap;max-width:200px;">'+i+'</pre></td><td><button type="button" class="btn btn-secondary" data-action="revoke">收回</button></td></tr>'})).join("");this.dom.ownersTableBody.innerHTML=a,Array.prototype.forEach.call(this.dom.ownersTableBody.querySelectorAll('button[data-action="revoke"]'),(function(e){e.addEventListener("click",(function(){var a=e.closest("tr");if(a){var d=a.getAttribute("data-user-id"),n=a.getAttribute("data-medal-id");d&&n&&t.revokeMedalFromUser(d,n)}}))}))}else this.dom.ownersTableBody.innerHTML='<tr><td colspan="6" class="medal-table__empty">暂无拥有者</td></tr>';this.dom.ownersPageLabel&&(this.dom.ownersPageLabel.textContent=String(this.ownersPage)),this.dom.ownersTotalLabel&&(this.dom.ownersTotalLabel.textContent=String(this.ownersTotal))}},grantMedalToUser:function(){var e=this;if(this.currentOwnersMedalId){var a=(this.dom.grantUserId.value||"").trim(),d=(this.dom.grantExpireTime.value||"").trim(),n=(this.dom.grantData.value||"").trim();if(a){$.ajax({url:"/user/"+a+"?apiKey="+apiKey,type:"GET",dataType:"json",async:!1,success:function(e){a=e.oId}}),console.log(a);var i=this.apiPayloadBase();i.medalId=this.currentOwnersMedalId,i.userId=a,i.expireTime=d,i.data=n,t("/api/medal/admin/grant",i).then((function(t){t&&0===t.code?(alert("发放成功"),e.loadMedalOwners(e.currentOwnersMedalId)):alert("发放失败："+(t?t.msg:"未知错误"))})).catch((function(e){alert("发放失败："+e)}))}else alert("用户名不能为空")}else alert("请先选择要发放的勋章")},revokeMedalFromUser:function(e,a){var d=this;if(window.confirm("确认收回该用户的此勋章吗？")){var n=this.apiPayloadBase();n.userId=e,n.medalId=a,t("/api/medal/admin/revoke",n).then((function(e){e&&0===e.code?(alert("收回成功"),d.loadMedalOwners(d.currentOwnersMedalId)):alert("收回失败："+(e?e.msg:"未知错误"))})).catch((function(e){alert("收回失败："+e)}))}}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){e.init()})):e.init()}function t(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"},body:JSON.stringify(t||{})}).then((function(e){return e.json()}))}}();