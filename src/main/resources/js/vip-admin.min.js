!function(){if("undefined"!=typeof window&&!r())var e=0,t=window.setInterval(function(){e+=1,(r()||e>=200)&&window.clearInterval(t)},50);function r(){if(window.__vipAdminInited)return!0;if(!document.getElementById("vipAdminRoot")||void 0===window.$)return!1;window.__vipAdminInited=!0;var e,t={page:1,pageSize:20,total:0,hasMore:!1,levels:[],levelById:{},levelByCode:{},currentRowLvCode:"",currentRowConfig:{}},r=["rainbow","neon","fire","ocean","forest","sunset","metal","galaxy"],i={bold:"昵称加粗",underline:"昵称下划线",color:"昵称颜色/特效",autoCheckin:"自动签到",checkinCard:"免签卡数量",metal:"DIY 动态勋章",jointVip:"联合会员"};function a(e,t){var r=t||"操作完成";window.Util&&"function"==typeof window.Util.notice?window.Util.notice("success"===e?"success":"error",2500,r):window.alert(r)}function n(e){return String(null==e?"":e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function o(e){var t=Number(e||0);if(!t||t<=0)return"永久";var r=new Date(t);return isNaN(r.getTime())?String(e):r.getFullYear()+"-"+("0"+(r.getMonth()+1)).slice(-2)+"-"+("0"+r.getDate()).slice(-2)+" "+("0"+r.getHours()).slice(-2)+":"+("0"+r.getMinutes()).slice(-2)}function l(e,t,r){$.ajax({url:e,type:"POST",contentType:"application/json;charset=UTF-8",dataType:"json",data:JSON.stringify(t||{}),success:function(e){r(null,e||{})},error:function(e){var t="请求失败";try{e&&e.responseJSON&&e.responseJSON.msg&&(t=e.responseJSON.msg)}catch(e){}r(new Error(t))}})}function v(e){if(!e||0!==e.code)throw new Error(e&&e.msg||"接口执行失败");return e.data||{}}function s(e,t){if(null==e||""===e)return t;if("object"==typeof e)return e;try{return JSON.parse(e)}catch(e){return t}}function c(e){if(!e)return{};var t=s(e.benefits,{});return t&&"object"==typeof t?t:{}}function p(e){return i[e]?i[e]+"（"+e+"）":e}function d(e){return/^VIP4/.test(String(e||""))}function u(e,t,i,a){var o=$(e),l=Object.keys(t||{});if(l.length){for(var v=function(e,t){for(var r={},i=t&&"object"==typeof t?t:{},a=Object.keys(e||{}),n=0;n<a.length;n++){var o=a[n];i.hasOwnProperty(o)&&void 0!==i[o]&&null!==i[o]?r[o]=i[o]:r[o]=e[o]}return r}(t,i),s="",c=0;c<l.length;c++){var u=l[c],f=t[u],g=v[u],m="text";if("boolean"==typeof f?m="bool":"number"==typeof f?m="number":Array.isArray(f)?m="array":f&&"object"==typeof f?m="object":"string"==typeof f&&("color"===u&&d(a)?m="vip4-color":"color"===u&&(m="color")),s+='<div class="vip-config-item" data-key="'+n(u)+'" data-type="'+n(m)+'">',s+="<label>"+n(p(u))+"</label>","bool"===m)s+='<input type="checkbox" class="vip-config-value" '+(g?"checked":"")+"/>";else if("number"===m){s+='<input type="number" class="vip-config-value" step="'+(Number.isInteger(Number(f))?"1":"any")+'" value="'+n(g)+'"/>'}else if("color"===m){s+='<input type="color" class="vip-config-value" value="'+n(/^#[0-9a-fA-F]{6}$/.test(String(g||""))?String(g):"#ff0000")+'"/>'}else if("vip4-color"===m){var h=String(g||""),y=r.indexOf(h)>=0;s+='<select class="vip-config-value vip4-color-select">';for(var b=0;b<r.length;b++){var w=r[b];s+='<option value="'+n(w)+'"'+(y&&w===h?" selected":"")+">"+n(w)+"</option>"}s+='<option value="__custom__"'+(y?"":" selected")+">自定义颜色</option>",s+="</select>",s+='<input type="text" class="vip-config-custom" placeholder="#RRGGBB 或类名" value="'+n(y?"":h)+'"'+(y?' style="display:none;"':"")+"/>"}else if("array"===m||"object"===m){var C="";try{C=JSON.stringify(g,null,2)}catch(e){C=""}s+='<textarea class="vip-config-value" rows="3" placeholder="JSON">'+n(C)+"</textarea>"}else s+='<input type="text" class="vip-config-value" value="'+n(g)+'"/>';s+="</div>"}o.html(s)}else o.html('<div class="vip-config-builder__empty">该等级没有可配置项</div>')}function f(e){var t={},r=!1,i=!1,a="";return $(e).find(".vip-config-item").each(function(){r=!0;var e=$(this),n=e.attr("data-key"),o=e.attr("data-type");try{if("bool"===o)t[n]=e.find(".vip-config-value").prop("checked");else if("number"===o){var l=$.trim(e.find(".vip-config-value").val()||"");if(""===l)throw new Error(n+" 不能为空");var v=Number(l);if(isNaN(v))throw new Error(n+" 不是有效数字");t[n]=v}else if("color"===o){var s=$.trim(e.find(".vip-config-value").val()||"");if(!/^#[0-9a-fA-F]{6}$/.test(s))throw new Error(n+" 颜色格式不正确");t[n]=s}else if("vip4-color"===o){var c=e.find(".vip4-color-select").val();if("__custom__"===c){var p=$.trim(e.find(".vip-config-custom").val()||"");if(""===p)throw new Error(n+" 不能为空");t[n]=p}else t[n]=c}else if("array"===o||"object"===o){var d=$.trim(e.find(".vip-config-value").val()||"");if(""===d)throw new Error(n+" 不能为空");t[n]=JSON.parse(d)}else{var u=$.trim(e.find(".vip-config-value").val()||"");if(""===u)throw new Error(n+" 不能为空");t[n]=u}}catch(e){return i=!0,a=e.message||n+" 配置错误",!1}}),{hasItem:r,hasError:i,errorMsg:a,data:t}}function g(){var e=function(e){return t.levelById[e]||null}($.trim($("#vipAddLevel").val()||"")),r=c(e);u("#vipAddConfigBuilder",r,r,e?e.lvCode:"")}function m(){return $.trim($("#vipUpdateLvCode").val()||"")||t.currentRowLvCode||""}function h(e){if($("#vipUpdateConfigEnabled").prop("checked")){var r=m();if(!r)return $("#vipUpdateConfigRow").show(),void $("#vipUpdateConfigBuilder").html('<div class="vip-config-builder__empty">请先选择等级或点“填入编辑”加载用户当前等级</div>');var i=function(e){return t.levelByCode[e]||null}(r),a=c(i);e||(e=t.currentRowConfig),u("#vipUpdateConfigBuilder",a,e,r),$("#vipUpdateConfigRow").show()}else $("#vipUpdateConfigRow").hide()}function y(){l("/api/admin/vip/list",function(){var e={page:t.page,pageSize:t.pageSize},r=$.trim($("#vipSearchUserName").val()||"");r&&(e.userName=r);var i=$.trim($("#vipSearchLvCode").val()||"");i&&(e.lvCode=i);var a=$.trim($("#vipSearchState").val()||"");return""!==a&&(e.state=Number(a)),e}(),function(e,r){var i;if(e)a("error",e.message);else try{var l=v(r),s=$.isArray(l.items)?l.items:[];t.total=Number(l.total||0),t.hasMore=t.page*t.pageSize<t.total,function(e){var t=$("#vipMembershipTableBody");if(e&&e.length){for(var r="",i=0;i<e.length;i++){var a=e[i]||{},l=a.runtimeState||"",v=1===a.state?"生效":"失效";"expired"===l&&(v="已过期"),"active"===l&&(v="生效");var s=a.userName||"",c=a.userId||"",p=a.lvCode||"",d=Number(a.expiresAt||0),u=a.configJson||"";r+="<tr><td>"+n(s)+"</td><td>"+n(c)+"</td><td>"+n(p)+"</td><td>"+n(v)+"</td><td>"+n(o(d))+"</td><td>"+n(o(a.updatedAt))+'</td><td><button type="button" class="vip-row-fill" data-user-id="'+n(c)+'" data-user-name="'+n(s)+'" data-lv-code="'+n(p)+'" data-state="'+n(a.state)+'" data-expires-at="'+n(d)+'" data-config-json="'+n(u)+'">填入编辑</button> <button type="button" class="green vip-row-extend" data-user-id="'+n(c)+'" data-user-name="'+n(s)+'">延长</button> <button type="button" class="red vip-row-refund" data-user-id="'+n(c)+'" data-user-name="'+n(s)+'">退款</button></td></tr>'}t.html(r)}else t.html('<tr><td colspan="7" class="ft-gray">暂无数据</td></tr>')}(s),i=Math.max(1,Math.ceil((t.total||0)/t.pageSize)),$("#vipPageInfo").text("第 "+t.page+" / "+i+" 页，共 "+(t.total||0)+" 条"),$("#vipPrevPage").prop("disabled",t.page<=1),$("#vipNextPage").prop("disabled",!t.hasMore)}catch(e){a("error",e.message)}})}function b(){var e=$.trim($("#vipAddUser").val()||""),t=$.trim($("#vipAddLevel").val()||"");if(e)if(t){var r=f("#vipAddConfigBuilder");if(r.hasError)a("error",r.errorMsg);else l("/api/admin/vip/add",{userIdOrName:e,levelOId:t,configJson:r.hasItem?JSON.stringify(r.data):""},function(e,t){if(e)a("error",e.message);else try{v(t),a("success","新增 VIP 成功"),y()}catch(e){a("error",e.message)}})}else a("error","请先选择等级");else a("error","请先填写用户")}function w(){var e=$.trim($("#vipUpdateUser").val()||"");if(e){var t={userIdOrName:e},r=$.trim($("#vipUpdateLvCode").val()||""),i=$.trim($("#vipUpdateState").val()||""),n=$.trim($("#vipUpdateExpiresAt").val()||"");if(r&&(t.lvCode=r),""!==i&&(t.state=Number(i)),""!==n&&(t.expiresAt=n),$("#vipUpdateConfigEnabled").prop("checked")){if(!m())return void a("error","请先选择等级，才能更新配置");var o=f("#vipUpdateConfigBuilder");if(o.hasError)return void a("error",o.errorMsg);t.configJson=o.hasItem?JSON.stringify(o.data):""}l("/api/admin/vip/update",t,function(e,t){if(e)a("error",e.message);else try{v(t),a("success","更新 VIP 成功"),y()}catch(e){a("error",e.message)}})}else a("error","请先填写用户")}function C(e){var t=$.trim(e||$("#vipUpdateUser").val()||"");if(t){var r=parseInt($.trim($("#vipExtendDays").val()||""),10);!r||r<=0?a("error","请填写大于 0 的延长天数"):l("/api/admin/vip/extend",{userIdOrName:t,days:r},function(e,t){if(e)a("error",e.message);else try{var i=v(t),n=Number(i.newExpiresAt||0);n>0&&$("#vipUpdateExpiresAt").val(String(n)),a("success","已延长 "+r+" 天，新到期："+o(n)),y()}catch(e){a("error",e.message)}})}else a("error","请先填写用户")}function U(e){var t=$.trim(e||"");t?window.confirm("确认执行 VIP 按天退款？退款后会员会立即失效。")&&l("/api/admin/vip/refund",{userIdOrName:t},function(e,t){if(e)a("error",e.message);else try{var r=v(t);a("success","退款成功：返还 "+Number(r.refundPoints||0)+" 积分（剩余 "+Number(r.remainingDays||0)+" 天）"),y()}catch(e){a("error",e.message)}}):a("error","请先填写用户")}return $("#vipSearchBtn").on("click",function(){t.page=1,y()}),$("#vipResetBtn").on("click",function(){$("#vipSearchUserName").val(""),$("#vipSearchLvCode").val(""),$("#vipSearchState").val(""),t.page=1,y()}),$("#vipPrevPage").on("click",function(){t.page<=1||(t.page-=1,y())}),$("#vipNextPage").on("click",function(){t.hasMore&&(t.page+=1,y())}),$("#vipAddLevel").on("change",function(){g()}),$("#vipUpdateLvCode").on("change",function(){h()}),$("#vipUpdateConfigEnabled").on("change",function(){h()}),$("#vipUpdateConfigBuilder").on("change",".vip4-color-select",function(){var e=$(this),t=e.closest(".vip-config-item").find(".vip-config-custom");"__custom__"===e.val()?t.show():t.hide()}),$("#vipAddConfigBuilder").on("change",".vip4-color-select",function(){var e=$(this),t=e.closest(".vip-config-item").find(".vip-config-custom");"__custom__"===e.val()?t.show():t.hide()}),$("#vipAddBtn").on("click",b),$("#vipUpdateBtn").on("click",w),$("#vipExtendBtn").on("click",function(){C($("#vipUpdateUser").val())}),$("#vipRefundBtn").on("click",function(){U($("#vipRefundUser").val())}),$("#vipClearExpiresBtn").on("click",function(){$("#vipUpdateExpiresAt").val("")}),$("#vipMembershipTableBody").on("click",".vip-row-fill",function(){var e=$(this),r=e.attr("data-user-name")||"",i=e.attr("data-user-id")||"",n=e.attr("data-lv-code")||"",o=e.attr("data-state")||"",l=e.attr("data-expires-at")||"",v=e.attr("data-config-json")||"";$("#vipUpdateUser").val(r||i),$("#vipRefundUser").val(r||i),$("#vipUpdateLvCode").val(n),$("#vipUpdateState").val(o),$("#vipUpdateExpiresAt").val(l),t.currentRowLvCode=n,t.currentRowConfig=s(v,{}),$("#vipUpdateConfigEnabled").prop("checked",!0),h(t.currentRowConfig),a("success","已填入编辑区域")}),$("#vipMembershipTableBody").on("click",".vip-row-extend",function(){var e=$(this),t=e.attr("data-user-name")||e.attr("data-user-id");$("#vipUpdateUser").val(t),C(t)}),$("#vipMembershipTableBody").on("click",".vip-row-refund",function(){var e=$(this);U(e.attr("data-user-name")||e.attr("data-user-id"))}),e=function(){y()},$.ajax({url:"/api/membership/levels",type:"GET",dataType:"json",success:function(r){try{var i=v(r);t.levels=$.isArray(i)?i:[],function(){var e=$("#vipSearchLvCode"),r=$("#vipAddLevel"),i=$("#vipUpdateLvCode");e.find("option:not(:first)").remove(),r.empty(),i.find("option:not(:first)").remove(),t.levelById={},t.levelByCode={};for(var a={},o=0;o<t.levels.length;o++){var l=t.levels[o]||{},v=l.oId||"",s=l.lvCode||"",c=l.lvName||"",p=Number(l.price||0),d=Number(l.durationValue||0);if(v){t.levelById[v]=l;var u=c+" ["+s+"] "+d+"天 / "+p+"积分";r.append('<option value="'+n(v)+'">'+n(u)+"</option>")}s&&!t.levelByCode[s]&&(t.levelByCode[s]=l),s&&!a[s]&&(a[s]=!0,e.append('<option value="'+n(s)+'">'+n(s)+"</option>"),i.append('<option value="'+n(s)+'">'+n(s)+"</option>"))}g(),h()}(),e&&e()}catch(e){a("error",e.message)}},error:function(){a("error","读取会员等级失败")}}),!0}}();