var EmojiGroups={NAME_PATTERN:/^[\p{L}\p{N}\s_\-。，！？!?:：；;（）()\[\]{}·]+$/u,NAME_MAX_LEN:20,init:function(o,e){e=e||"New";var t=window[o];t?(t["emojiGroups"+e]=[],t["emojiGroupsData"+e]={},t["currentEmojiGroupId"+e]=null,t["loadEmojiGroups"+e]=EmojiGroups._createLoadMethod(t,e),t["renderEmojiGroups"+e]=EmojiGroups._createRenderMethod(t,e),t["selectEmojiGroup"+e]=EmojiGroups._createSelectMethod(t,e),t["loadGroupEmojis"+e]=EmojiGroups._createLoadEmojisMethod(t,e,o),t["renderGroupEmojis"+e]=EmojiGroups._createRenderEmojisMethod(t,e,o),t["uploadEmojiToGroup"+e]=EmojiGroups._createUploadEmojiMethod(t,e),console.log("表情包分组模块已挂载到对象:",o)):console.error("目标对象不存在:",o)},_createLoadMethod:function(o,e){return function(){$.ajax({url:Label.servePath+"/api/emoji/groups",type:"GET",cache:!1,success:function(t){if(0==t.code){var i=t.data||[];o["emojiGroups"+e]=i,o["renderEmojiGroups"+e](i);for(let t=0;t<i.length;t++)if(1===i[t].type){o["currentEmojiGroupId"+e]=i[t].oId,setTimeout((function(){o["selectEmojiGroup"+e](i[t].oId)}),50);break}}else console.error("加载分组失败:",t.msg)},error:function(){console.error("加载分组失败，请检查网络")}})}},_createRenderMethod:function(o,e){return function(t){let i=$("#emojiGroupBox"+e);if(0!==i.length){i.empty();for(let r=0;r<t.length;r++){let n=t[r],l=$("<div>",{class:"emoji_group_"+e,id:"emojiGroup"+e+"_"+n.oId,"data-id":n.oId,"data-name":n.name,"data-type":n.type,css:{padding:"8px 12px",cursor:"pointer","border-bottom":"1px solid #eee","font-size":"14px",overflow:"hidden","line-clamp":"1","white-space":"nowrap","text-overflow":"ellipsis"}}),a=$("<span>",{class:"group_name_"+e,text:n.name,css:{display:"inline-block",width:"100%"}});a.on("click",(function(t){t.stopPropagation();var i=$(this).closest(".emoji_group_"+e).data("id");o["selectEmojiGroup"+e](i)})),l.append(a),i.append(l)}}}},_createSelectMethod:function(o,e){return function(t){o["currentEmojiGroupId"+e]=t,$(".emoji_group_"+e).css({"background-color":"",color:"","font-weight":""}),$("#emojiGroup"+e+"_"+t).css({"background-color":"#e6f7ff",color:"#1890ff","font-weight":"bold"}),o["loadGroupEmojis"+e](t)}},_createLoadEmojisMethod:function(o,e,t){return function(t){o["emojiGroupsData"+e][t]?o["renderGroupEmojis"+e](o["emojiGroupsData"+e][t]):$.ajax({url:Label.servePath+"/api/emoji/group/emojis?groupId="+t,type:"GET",cache:!1,success:function(i){if(0==i.code){var r=i.data||[];o["emojiGroupsData"+e][t]=r,o["renderGroupEmojis"+e](r)}else console.error("加载表情失败:",i.msg)},error:function(){console.error("加载表情失败，请检查网络")}})}},_createRenderEmojisMethod:function(o,e,t){return function(i){var r="",n=(o.editor,Label.servePath+"/settings/function#emojiGroupBox");if(r+='<div class="emoji_manage_bar" style="display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #eee;"><span style="font-size:13px;color:#666;">表情包</span><a style="font-size:12px;color:#1890ff;" target="_blank" href="'+n+'">管理/迁移</a></div>',0===i.length)r+='<div style="text-align: center; padding: 20px; color: #999; line-height: 1.6;">该分组暂无表情<br><a style="color:#1890ff;" target="_blank" href="'+n+'">前往表情包管理迁移旧表情</a></div>';else{i.sort((function(o,e){return e.sort-o.sort}));for(let o=0;o<i.length;o++){r+='<button class="emoji-insert-btn" data-url="'+String(i[o].url||"").replace(/"/g,"&quot;")+'" data-emoji-id="'+(i[o].emojiId||"")+'" style="position:relative;">',r+='<span class="emoji-del-btn" style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.45);color:#fff;border-radius:50%;width:16px;height:16px;line-height:16px;font-size:12px;display:flex;align-items:center;justify-content:center;">×</span>',r+='<img style="max-height: 50px" class="vditor-emojis__icon" src="'+i[o].url+'">',r+="</button>"}}var l=$("#emojis"+e);l.html(r),l.off("click.emojiInsert").on("click.emojiInsert","button.emoji-insert-btn",(function(o){o.preventDefault();var e=$(this).data("url");$(o.target).hasClass("emoji-del-btn")||EmojiGroups.insertEmojiToEditor(t,e)})),l.off("click.emojiDelete").on("click.emojiDelete",".emoji-del-btn",(function(t){t.preventDefault(),t.stopPropagation();var i=$(this).closest("button").data("emoji-id"),r=o["currentEmojiGroupId"+e];i&&r?confirm("确定删除该表情吗？")&&EmojiGroups._deleteEmojiFromGroup(r,i,(function(){delete o["emojiGroupsData"+e][r],o["loadGroupEmojis"+e](r)})):Util&&Util.alert?Util.alert("删除失败：缺少参数"):console.error("删除失败：缺少参数")}))}},_createUploadEmojiMethod:function(o,e){return function(t){$.ajax({url:Label.servePath+"/api/emoji/upload",type:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify({url:t}),cache:!1,success:function(t){if(0==t.code){var i=o["currentEmojiGroupId"+e];EmojiGroups._refreshGroupsCache(o,e,[i,EmojiGroups._findAllGroupId(o,e)])}else console.error("上传表情失败:",t.msg),alert("上传表情失败: "+t.msg)},error:function(){console.error("上传表情失败，请检查网络"),alert("上传表情失败，请检查网络")}})}},_deleteEmojiFromGroup:function(o,e,t){$.ajax({url:Label.servePath+"/api/emoji/group/remove-emoji",type:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify({groupId:o,emojiId:e}),success:function(o){0===o.code?(Util&&Util.notice?Util.notice("success",1200,"表情已删除"):console.log("表情已删除"),t&&t()):Util&&Util.alert?Util.alert(o.msg||"删除失败"):console.error(o.msg)},error:function(){Util&&Util.alert?Util.alert("删除失败，请检查网络"):console.error("删除失败，请检查网络")}})},insertEmojiToEditor:function(o,e){var t=window[o];if(t&&t.editor){try{if(t.editor.insertValue)t.editor.insertValue("![图片表情]("+e+")",!0);else if(t.editor.setValue){var i=t.editor.getValue?t.editor.getValue():"";t.editor.setValue(i+"![图片表情]("+e+")")}}catch(o){console.error("插入表情失败",o)}t.editor.focus&&t.editor.focus(),EmojiGroups.closePanel()}else EmojiGroups._toast("编辑器尚未就绪，请稍后再试")},openCollectDialog:function(o,e){var t=Array.isArray(o)?o:[o];if(t&&0!==t.length&&(t=t.map((function(o){return String(o||"").trim()})).filter(Boolean),(t=Array.from(new Set(t))).length)){var i=window.Chat&&window.Chat.emojiGroupsNew||window.ChatRoom&&window.ChatRoom.emojiGroupsNew||window.Comment&&window.Comment.emojiGroupsNew||window.Settings&&window.Settings.emojiGroupsNew||window.Settings&&window.Settings.emojiGroups||[];if(!i||!i.length)try{$.ajax({url:Label.servePath+"/api/emoji/groups",type:"GET",async:!1,success:function(o){0===o.code&&(i=o.data||[])}})}catch(o){}if(i&&i.length){for(var r="",n=0;n<i.length;n++)r+='<option value="'+i[n].oId+'">'+i[n].name+"</option>";EmojiGroups._pendingCollectUrls=t;var l='<div id="emojiCollectOverlay" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 180ms ease-out;background:rgba(0,0,0,0.25);"><div id="emojiCollectDialog" style="width:92%;max-width:420px;background:#fff;border-radius:12px;box-shadow:0 18px 46px rgba(0,0,0,0.18);padding:18px 16px;box-sizing:border-box;font-size:14px;line-height:1.6;opacity:0;transform:scale(0.9) translateY(12px);transition:opacity 200ms ease-out, transform 240ms ease-out;"><div style="font-weight:600;font-size:15px;margin-bottom:12px;">收藏表情到分组</div><div style="margin-bottom:12px;">  <div style="font-size:13px;color:#666;margin-bottom:6px;">选择分组：</div>  <select id="collectGroupSelect" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:6px;font-size:14px;">'+r+'</select></div><div style="margin-bottom:14px;">  <div style="font-size:13px;color:#666;margin-bottom:6px;">表情名称（可选，用于展示）</div>  <input id="collectEmojiName" type="text" value="'+(e||"")+'" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:6px;font-size:14px;box-sizing:border-box;" /></div><div style="text-align:right;display:flex;gap:10px;justify-content:flex-end;">  <button id="collectCancelBtn" style="min-width:80px;padding:8px 10px;border:1px solid #d9d9d9;background:#fff;border-radius:6px;cursor:pointer;">取消</button>  <button id="collectOkBtn" style="min-width:80px;padding:8px 10px;border:1px solid #1890ff;background:#1890ff;color:#fff;border-radius:6px;cursor:pointer;">确定</button></div></div></div>';$("#emojiCollectOverlay").remove(),$("body").append(l),$("#collectOkBtn").off("click").on("click",EmojiGroups._confirmCollectEmojiInline),$("#collectCancelBtn").off("click").on("click",EmojiGroups.closeCollectDialog),$("#emojiCollectOverlay").off("click").on("click",(function(o){o.target&&"emojiCollectOverlay"===o.target.id&&EmojiGroups.closeCollectDialog()})),setTimeout((function(){$("#emojiCollectOverlay").css("opacity","1"),$("#emojiCollectDialog").css({opacity:1,transform:"scale(1) translateY(0)"})}),10)}else Util&&Util.alert?Util.alert("未获取到分组，请稍后重试"):alert("未获取到分组")}},_confirmCollectEmojiInline:function(){var o=$("#collectGroupSelect").val(),e=$("#collectEmojiName").val().trim(),t=EmojiGroups._pendingCollectUrls||[];if(o){var i=function(r){if(r>=t.length)return EmojiGroups.closeCollectDialog(),void(Util&&Util.notice?Util.notice("success",1200,"收藏成功"):console.log("收藏成功"));EmojiGroups._addUrlEmojiToGroup(o,t[r],e,(function(){i(r+1)}),(function(){Util&&Util.closeAlert&&Util.closeAlert()}))};i(0)}else Util&&Util.alert?Util.alert("请选择分组"):alert("请选择分组")},_addUrlEmojiToGroup:function(o,e,t,i,r){$.ajax({url:Label.servePath+"/api/emoji/group/add-url-emoji",type:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify({groupId:o,url:e,sort:0,name:t||""}),success:function(e){0===e.code?(i&&i(),EmojiGroups._refreshGroupsCacheForAll([o])):(EmojiGroups._toast(e.msg||"收藏失败"),EmojiGroups.closeCollectDialog(),r&&r())},error:function(){EmojiGroups._toast("收藏失败，请检查网络"),EmojiGroups.closeCollectDialog(),r&&r()}})},closeCollectDialog:function(){var o=$("#emojiCollectOverlay"),e=$("#emojiCollectDialog");o.length&&(o.css("opacity","0"),e.css({opacity:0,transform:"scale(0.9) translateY(12px)"}),setTimeout((function(){o.remove()}),220))},_toast:function(o){"undefined"!=typeof Util&&Util.notice?Util.notice("warning",2e3,o):"undefined"!=typeof Util&&Util.alert?Util.alert(o):alert(o)},_refreshGroupsCache:function(o,e,t){if(o&&o["emojiGroupsData"+e]){var i=(t||[]).filter(Boolean);if(i.length){for(var r=0;r<i.length;r++)delete o["emojiGroupsData"+e][i[r]];o["emojiGroupsDirty"+e]=!0;var n=o["currentEmojiGroupId"+e];n&&-1!==i.indexOf(n)&&o["loadGroupEmojis"+e]&&(o["loadGroupEmojis"+e](n),o["emojiGroupsDirty"+e]=!1)}}},_refreshGroupsCacheForAll:function(o){var e=(o||[]).filter(Boolean);if(e.length)for(var t=[window.Chat,window.ChatRoom,window.Comment,window.Settings],i="New",r=0;r<t.length;r++){var n=t[r];if(n&&n["emojiGroupsData"+i]){var l=e.slice(),a=EmojiGroups._findAllGroupId(n,i);a&&l.push(a);for(var s=0;s<l.length;s++)delete n["emojiGroupsData"+i][l[s]];n["emojiGroupsDirty"+i]=!0}}},_findAllGroupId:function(o,e){var t=o?o["emojiGroups"+e]:null;if(!t||!t.length)return null;for(var i=0;i<t.length;i++)if(1===t[i].type)return t[i].oId;return null},closePanel:function(){var o=$("#emojiList");o.length&&o.removeClass("showList"),$("details[open]").removeAttr("open")},ensureCurrentFresh:function(o,e){if(e=e||"New",o&&o["emojiGroupsData"+e]&&o["emojiGroupsDirty"+e]){var t=o["currentEmojiGroupId"+e];t&&o["loadGroupEmojis"+e]&&(delete o["emojiGroupsData"+e][t],o["emojiGroupsDirty"+e]=!1,o["loadGroupEmojis"+e](t))}}};